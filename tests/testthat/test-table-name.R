test_that("table_name possess key methods", {
  expect_snapshot({
    name <- table_name(c("x", "y", "z"))
    name
  })

  expect_equal(name[c(1, 3)], table_name(c("x", "z")))
  expect_equal(name[[2]], table_name("y"))
  expect_equal(c(name[[1]], name[[2]]), table_name(c("x", "y")))
})

test_that("can check for table name", {
  foo <- function(y) check_table_name(y)
  expect_snapshot(foo(1), error = TRUE)
})

# as_table_name -----------------------------------------------------------

test_that("can coerce all user facing inputs", {
  con <- simulate_dbi()

  x_esc <- table_name("`x`")
  x_raw <- table_name("x")

  id <- table_name("x")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), x_raw)

  id <- "x"
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), x_esc)

  id <- I("x")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), x_raw)

  id <- ident("x")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), x_esc)

  id <- ident_q("x")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), x_raw)

  id <- DBI::Id(schema = "foo", table = "bar")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), table_name("`foo`.`bar`"))

  # strip names, simulating DBI 1.2.0
  names(id@name) <- NULL
  expect_equal(as_table_name(id, con), table_name("`foo`.`bar`"))

  id <- in_schema("foo", "bar")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), table_name("`foo`.`bar`"))

  id <- in_catalog("foo", "bar", "baz")
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), table_name("`foo`.`bar`.`baz`"))

  id <- in_catalog("foo", sql("bar"), ident_q("baz"))
  expect_true(is_table_id(id))
  expect_equal(as_table_name(id, con), table_name("`foo`.bar.baz"))
})

test_that("strips names", {
  con <- simulate_dbi()
  expect_equal(as_table_name(c(x = "x"), con), table_name("`x`"))

  id <- in_schema(c(x = "a"), "b")
  expect_equal(as_table_name(id, con), table_name("`a`.`b`"))

  id <- in_catalog("a", "b", c(x = "c"))
  expect_equal(as_table_name(id, con), table_name("`a`.`b`.`c`"))
})

test_that("as_table_name validates its inputs", {
  con <- simulate_dbi()
  expect_snapshot(error = TRUE, {
    as_table_name("x")
    as_table_name(c("x", "y"), con)
    as_table_name(1, con)
    as_table_name(I(1), con)
  })
})

test_that("as_table_name warns when using sql", {
  con <- simulate_dbi()
  expect_snapshot(as_table_name(sql("x"), con))
})
