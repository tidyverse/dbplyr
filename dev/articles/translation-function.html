<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Function translation • dbplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<!--optional theme--><link href="../.css" rel="stylesheet">
<meta property="og:title" content="Function translation">
<meta property="og:description" content="dbplyr">
<meta property="og:image" content="https://dbplyr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dbplyr</a>
        <div class="info hidden-xs hidden-sm">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">2.0.0.9000</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/dbplyr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/backend-2.html">dplyr 2.0.0 backend API</a>
    </li>
    <li>
      <a href="../articles/new-backend.html">Adding a new DBI backend</a>
    </li>
    <li>
      <a href="../articles/reprex.html">Reprexes for dbplyr</a>
    </li>
    <li>
      <a href="../articles/sql.html">Writing SQL with dbplyr</a>
    </li>
    <li>
      <a href="../articles/translation-function.html">Function translation</a>
    </li>
    <li>
      <a href="../articles/translation-verb.html">Verb translation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2020/11/dbplyr-2-0-0/">Version 2.0.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/04/dbplyr-1-4-0/">Version 1.4.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/01/dbplyr-1-3-0/">Version 1.3.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/01/dbplyr-1-2/">Version 1.2.0</a>
    </li>
    <li>
      <a href="https://blog.rstudio.com/2017/06/27/dbplyr-1-1-0/">Version 1.1.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/tidyverse/dbplyr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="translation-function_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Function translation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/master/vignettes/translation-function.Rmd"><code>vignettes/translation-function.Rmd</code></a></small>
      <div class="hidden name"><code>translation-function.Rmd</code></div>

    </div>

    
    
<p>There are two parts to dbplyr SQL translation: translating dplyr verbs, and translating expressions within those verbs. This vignette describes how individual expressions (function calls) are translated; <code>vignette("translate-verb")</code> describes how entire verbs are translated.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/translate_sql.html">dbplyr::translate_sql()</a></code> powers translation of individual function calls, and I’ll use it extensively in this vignette to show what’s happening. You shouldn’t need to use it ordinary code as dbplyr takes care of the translation automatically.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; (`x` + `y`) / 2.0</span></code></pre></div>
<p><code><a href="../reference/translate_sql.html">translate_sql()</a></code> takes an optional <code>con</code> parameter. If not supplied, this causes dplyr to generate (approximately) SQL-92 compliant SQL. If supplied, dplyr uses <code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_translate_env()</a></code> to look up a custom environment which makes it possible for different databases to generate slightly different SQL: see <code><a href="../articles/new-backend.html">vignette("new-backend")</a></code> for more details. You can use the various simulate helpers to see the translations used by different backends:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2L</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; POWER(`x`, 2)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2L</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/backend-sqlite.html">simulate_sqlite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; POWER(`x`, 2)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2L</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/backend-access.html">simulate_access</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; `x` ^ 2</span></code></pre></div>
<p>Perfect translation is not possible because databases don’t have all the functions that R does. The goal of dplyr is to provide a semantic rather than a literal translation: what you mean, rather than precisely what is done. In fact, even for functions that exist both in databases and R, you shouldn’t expect results to be identical; database programmers have different priorities than R core programmers. For example, in R in order to get a higher level of numerical accuracy, <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> loops through the data twice. R’s <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> also provides a <code>trim</code> option for computing trimmed means; this is something that databases do not provide.</p>
<p>If you’re interested in how <code><a href="../reference/translate_sql.html">translate_sql()</a></code> is implemented, the basic techniques that underlie the implementation of <code><a href="../reference/translate_sql.html">translate_sql()</a></code> are described in <a href="https://adv-r.hadley.nz/translation.html">“Advanced R”</a>.</p>
<div id="basic-differences" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-differences" class="anchor"></a>Basic differences</h2>
<p>The following examples work through some of the basic differences between R and SQL.</p>
<ul>
<li>
<p><code>"</code> and <code>'</code> mean different things</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># In SQLite variable names are escaped by double quotes:</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; `x`</span>
<span class="co"># And strings are escaped by single quotes</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; 'x'</span></code></pre></div>
</li>
<li>
<p>And some functions have different argument orders:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; SUBSTR(`x`, 5, 6)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; LOG(10.0, `x`)</span></code></pre></div>
</li>
<li>
<p>R and SQL have different defaults for integers and reals. In R, 1 is a real, and 1L is an integer. In SQL, 1 is an integer, and 1.0 is a real</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; 1.0</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; 1</span></code></pre></div>
</li>
</ul>
</div>
<div id="known-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#known-functions" class="anchor"></a>Known functions</h2>
<div id="mathematics" class="section level3">
<h3 class="hasAnchor">
<a href="#mathematics" class="anchor"></a>Mathematics</h3>
<ul>
<li>basic math operators: <code><a href="https://rdrr.io/r/base/Arithmetic.html">+</a></code>, <code><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></code>, <code><a href="https://rdrr.io/r/base/Arithmetic.html">*</a></code>, <code><a href="https://rdrr.io/r/base/Arithmetic.html">/</a></code>, <code><a href="https://rdrr.io/r/base/Arithmetic.html">^</a></code>
</li>
<li>trigonometry: <code><a href="https://rdrr.io/r/base/Trig.html">acos()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html">asin()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html">atan()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html">atan2()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html">cos()</a></code>, <code>cot()</code>, <code><a href="https://rdrr.io/r/base/Trig.html">tan()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html">sin()</a></code>
</li>
<li>hypergeometric: <code><a href="https://rdrr.io/r/base/Hyperbolic.html">cosh()</a></code>, <code>coth()</code>, <code><a href="https://rdrr.io/r/base/Hyperbolic.html">sinh()</a></code>, <code><a href="https://rdrr.io/r/base/Hyperbolic.html">tanh()</a></code>
</li>
<li>logarithmic: <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code>, <code><a href="https://rdrr.io/r/base/Log.html">log10()</a></code>, <code><a href="https://rdrr.io/r/base/Log.html">exp()</a></code>
</li>
<li>misc: <code><a href="https://rdrr.io/r/base/MathFun.html">abs()</a></code>, <code><a href="https://rdrr.io/r/base/Round.html">ceiling()</a></code>, <code><a href="https://rdrr.io/r/base/MathFun.html">sqrt()</a></code>, <code><a href="https://rdrr.io/r/base/sign.html">sign()</a></code>, <code><a href="https://rdrr.io/r/base/Round.html">round()</a></code>
</li>
</ul>
</div>
</div>
<div id="modulo-arithmetic" class="section level2">
<h2 class="hasAnchor">
<a href="#modulo-arithmetic" class="anchor"></a>Modulo arithmetic</h2>
<p>dbplyr translates <code><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></code> to the SQL equivalents but note that it’s not precisely the same: most databases use truncated division where the modulo operator takes the sign of the dividend, where R using the mathematically preferred floored division with the modulo sign taking the sign of the divisor.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>
  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">10L</span>, <span class="op">-</span><span class="fl">10L</span>, <span class="op">-</span><span class="fl">10L</span><span class="op">)</span>, 
  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="op">-</span><span class="fl">3L</span>, <span class="fl">3L</span>, <span class="op">-</span><span class="fl">3L</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/memdb_frame.html">tbl_memdb</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>

<span class="va">df</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%%</span> <span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt;       x     y `x%%y`</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1    10     3      1</span>
<span class="co">#&gt; 2    10    -3     -2</span>
<span class="co">#&gt; 3   -10     3      2</span>
<span class="co">#&gt; 4   -10    -3     -1</span>
<span class="va">mf</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%%</span> <span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; # Source:   lazy query [?? x 3]</span>
<span class="co">#&gt; # Database: sqlite 3.34.1 [:memory:]</span>
<span class="co">#&gt;       x     y `x%%y`</span>
<span class="co">#&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt;</span>
<span class="co">#&gt; 1    10     3      1</span>
<span class="co">#&gt; 2    10    -3      1</span>
<span class="co">#&gt; 3   -10     3     -1</span>
<span class="co">#&gt; 4   -10    -3     -1</span></code></pre></div>
<p>dbplyr no longer translates <code><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></code> because there’s no robust cross-database translation available.</p>
<div id="logical-comparisons" class="section level3">
<h3 class="hasAnchor">
<a href="#logical-comparisons" class="anchor"></a>Logical comparisons</h3>
<ul>
<li>logical comparisons: <code><a href="https://rdrr.io/r/base/Comparison.html">&lt;</a></code>, <code><a href="https://rdrr.io/r/base/Comparison.html">&lt;=</a></code>, <code><a href="https://rdrr.io/r/base/Comparison.html">!=</a></code>, <code><a href="https://rdrr.io/r/base/Comparison.html">&gt;=</a></code>, <code><a href="https://rdrr.io/r/base/Comparison.html">&gt;</a></code>, <code><a href="https://rdrr.io/r/base/Comparison.html">==</a></code>, <code><a href="https://rdrr.io/r/base/match.html">%in%</a></code>
</li>
<li>boolean operations: <code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code>, <code><a href="https://rdrr.io/r/base/Logic.html">&amp;&amp;</a></code>, <code><a href="https://rdrr.io/r/base/Logic.html">|</a></code>, <code><a href="https://rdrr.io/r/base/Logic.html">||</a></code>, <code><a href="https://rdrr.io/r/base/Logic.html">!</a></code>, <code><a href="https://rdrr.io/r/base/Logic.html">xor()</a></code>
</li>
</ul>
</div>
<div id="aggregation" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregation" class="anchor"></a>Aggregation</h3>
<p>All database provide translation for the basic aggregations: <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>, <code><a href="https://rdrr.io/r/stats/sd.html">sd()</a></code>, <code><a href="https://rdrr.io/r/stats/cor.html">var()</a></code>. Databases automatically drop NULLs (their equivalent of missing values) whereas in R you have to ask nicely. The aggregation functions warn you about this important difference:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning: Missing values are always removed in SQL.</span>
<span class="co">#&gt; Use `AVG(x, na.rm = TRUE)` to silence this warning</span>
<span class="co">#&gt; This warning is displayed only once per session.</span>
<span class="co">#&gt; &lt;SQL&gt; AVG(`x`) OVER ()</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; AVG(`x`) OVER ()</span></code></pre></div>
<p>Note that, by default, <code>translate()</code> assumes that the call is inside a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> or <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> and generates a window translation. If you want to see the equivalent <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>/aggregation translation, use <code>window = FALSE</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, window <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; AVG(`x`)</span></code></pre></div>
</div>
<div id="conditional-evaluation" class="section level3">
<h3 class="hasAnchor">
<a href="#conditional-evaluation" class="anchor"></a>Conditional evaluation</h3>
<p><code>if</code> and <code><a href="https://rdrr.io/r/base/switch.html">switch()</a></code> are translate to <code>CASE WHEN</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span> <span class="st">"big"</span> <span class="kw">else</span> <span class="st">"small"</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; CASE WHEN (`x` &gt; 5.0) THEN ('big') WHEN NOT(`x` &gt; 5.0) THEN ('small') END</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/switch.html">switch</a></span><span class="op">(</span><span class="va">x</span>, a <span class="op">=</span> <span class="fl">1L</span>, b <span class="op">=</span> <span class="fl">2L</span>, <span class="fl">3L</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; CASE `x` WHEN ('a') THEN (1) WHEN ('b') THEN (2) ELSE (3) END</span></code></pre></div>
</div>
<div id="string-manipulation" class="section level3">
<h3 class="hasAnchor">
<a href="#string-manipulation" class="anchor"></a>String manipulation</h3>
</div>
<div id="datetime" class="section level3">
<h3 class="hasAnchor">
<a href="#datetime" class="anchor"></a>Date/time</h3>
<ul>
<li>string functions: <code>tolower</code>, <code>toupper</code>, <code>trimws</code>, <code>nchar</code>, <code>substr</code>
</li>
<li>coerce types: <code>as.numeric</code>, <code>as.integer</code>, <code>as.character</code>
</li>
</ul>
</div>
</div>
<div id="unknown-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#unknown-functions" class="anchor"></a>Unknown functions</h2>
<p>Any function that dplyr doesn’t know how to convert is left as is. This means that database functions that are not covered by dplyr can be used directly via <code><a href="../reference/translate_sql.html">translate_sql()</a></code>. Here a couple of examples that will work with <a href="https://www.sqlite.org/lang_corefunc.html">SQLite</a>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu">glob</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; glob(`x`, `y`)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%like%</span> <span class="st">"ab%"</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; `x` like 'ab%'</span></code></pre></div>
<p>See <code><a href="../articles/sql.html">vignette("sql")</a></code> for more details.</p>
</div>
<div id="window-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#window-functions" class="anchor"></a>Window functions</h2>
<p>Things get a little trickier with window functions, because SQL’s window functions are considerably more expressive than the specific variants provided by base R or dplyr. They have the form <code>[expression] OVER ([partition clause] [order clause] [frame_clause])</code>:</p>
<ul>
<li><p>The <strong>expression</strong> is a combination of variable names and window functions. Support for window functions varies from database to database, but most support the ranking functions, <code>lead</code>, <code>lag</code>, <code>nth</code>, <code>first</code>, <code>last</code>, <code>count</code>, <code>min</code>, <code>max</code>, <code>sum</code>, <code>avg</code> and <code>stddev</code>.</p></li>
<li><p>The <strong>partition clause</strong> specifies how the window function is broken down over groups. It plays an analogous role to <code>GROUP BY</code> for aggregate functions, and <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> in dplyr. It is possible for different window functions to be partitioned into different groups, but not all databases support it, and neither does dplyr.</p></li>
<li><p>The <strong>order clause</strong> controls the ordering (when it makes a difference). This is important for the ranking functions since it specifies which variables to rank by, but it’s also needed for cumulative functions and lead. Whenever you’re thinking about before and after in SQL, you must always tell it which variable defines the order. If the order clause is missing when needed, some databases fail with an error message while others return non-deterministic results.</p></li>
<li>
<p>The <strong>frame clause</strong> defines which rows, or <strong>frame</strong>, that are passed to the window function, describing which rows (relative to the current row) should be included. The frame clause provides two offsets which determine the start and end of frame. There are three special values: -Inf means to include all preceding rows (in SQL, “unbounded preceding”), 0 means the current row (“current row”), and Inf means all following rows (“unbounded following”). The complete set of options is comprehensive, but fairly confusing, and is summarised visually below.</p>
<p><img src="windows.png" width="100%"></p>
<p>Of the many possible specifications, there are only three that commonly used. They select between aggregation variants:</p>
<ul>
<li><p>Recycled: <code>BETWEEN UNBOUND PRECEEDING AND UNBOUND FOLLOWING</code></p></li>
<li><p>Cumulative: <code>BETWEEN UNBOUND PRECEEDING AND CURRENT ROW</code></p></li>
<li><p>Rolling: <code>BETWEEN 2 PRECEEDING AND 2 FOLLOWING</code></p></li>
</ul>
<p>dplyr generates the frame clause based on whether your using a recycled aggregate or a cumulative aggregate.</p>
</li>
</ul>
<p>To see how individual window functions are translated to SQL, we can again use <code><a href="../reference/translate_sql.html">translate_sql()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; AVG(`G`) OVER ()</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; RANK() OVER (ORDER BY `G`)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span><span class="op">(</span><span class="va">G</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; NTILE(2) OVER (ORDER BY `G`)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; LAG(`G`, 1, NULL) OVER ()</span></code></pre></div>
<p>If the tbl has been grouped or arranged previously in the pipeline, then dplyr will use that information to set the “partition by” and “order by” clauses. For interactive exploration, you can achieve the same effect by setting the <code>vars_group</code> and <code>vars_order</code> arguments to <code><a href="../reference/translate_sql.html">translate_sql()</a></code></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/cumall.html">cummean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span>, vars_order <span class="op">=</span> <span class="st">"year"</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; AVG(`G`) OVER (ORDER BY `year` ROWS UNBOUNDED PRECEDING)</span>
<span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="op">)</span>, vars_group <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span>
<span class="co">#&gt; &lt;SQL&gt; RANK() OVER (PARTITION BY `ID`)</span></code></pre></div>
<p>There are some challenges when translating window functions between R and SQL, because dplyr tries to keep the window functions as similar as possible to both the existing R analogues and to the SQL functions. This means that there are three ways to control the order clause depending on which window function you’re using:</p>
<ul>
<li><p>For ranking functions, the ordering variable is the first argument: <code><a href="https://rdrr.io/r/base/rank.html">rank(x)</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile(y, 2)</a></code>. If omitted or <code>NULL</code>, will use the default ordering associated with the tbl (as set by <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>).</p></li>
<li><p>Accumulating aggregates only take a single argument (the vector to aggregate). To control ordering, use <code><a href="https://dplyr.tidyverse.org/reference/order_by.html">order_by()</a></code>.</p></li>
<li><p>Aggregates implemented in dplyr (<code>lead</code>, <code>lag</code>, <code>nth_value</code>, <code>first_value</code>, <code>last_value</code>) have an <code>order_by</code> argument. Supply it to override the default ordering.</p></li>
</ul>
<p>The three options are illustrated in the snippet below:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>,
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank</a></span><span class="op">(</span><span class="va">yearID</span><span class="op">)</span>,
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/order_by.html">order_by</a></span><span class="op">(</span><span class="va">yearID</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span>,
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span><span class="op">(</span><span class="va">G</span>, order_by <span class="op">=</span> <span class="va">yearID</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Currently there is no way to order by multiple variables, except by setting the default ordering with <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>. This will be added in a future release.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>dbplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Maximilian Girlich, Edgar Ruiz, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  


  </body>
</html>
