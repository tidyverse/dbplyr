<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Function translation • dbplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Function translation">
<meta name="robots" content="noindex">
<script defer data-domain="dbplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dbplyr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.5.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dbplyr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/backend-2.html">dbplyr 2.0.0 backend API</a></li>
    <li><a class="dropdown-item" href="../articles/new-backend.html">Adding a new DBI backend</a></li>
    <li><a class="dropdown-item" href="../articles/reprex.html">Reprexes for dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/sql.html">Writing SQL with dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/translation-function.html">Function translation</a></li>
    <li><a class="dropdown-item" href="../articles/translation-verb.html">Verb translation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2024/04/dbplyr-2-5-0/">Version 2.5.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/dbplyr-2-4-0/">Version 2.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/01/dbplyr-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2022/06/dbplyr-2-2-0/">Version 2.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/02/dplyr-backends/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/11/dbplyr-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/dbplyr-1-4-0/">Version 1.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/01/dbplyr-1-3-0/">Version 1.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/01/dbplyr-1-2/">Version 1.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2017/06/27/dbplyr-1-1-0/">Version 1.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/dbplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Function translation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/main/vignettes/translation-function.Rmd" class="external-link"><code>vignettes/translation-function.Rmd</code></a></small>
      <div class="d-none name"><code>translation-function.Rmd</code></div>
    </div>

    
    
<p>There are two parts to dbplyr SQL translation: translating dplyr
verbs, and translating expressions within those verbs. This vignette
describes how individual expressions (function calls) are translated;
<code><a href="../articles/translation-verb.html">vignette("translation-verb")</a></code> describes how entire verbs are
translated.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_dbi.html">simulate_dbi</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/translate_sql.html">dbplyr::translate_sql()</a></code> powers translation of individual
function calls, and I’ll use it extensively in this vignette to show
what’s happening. You shouldn’t need to use it ordinary code as dbplyr
takes care of the translation automatically.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; (`x` + `y`) / 2.0</span></span></code></pre></div>
<p><code><a href="../reference/translate_sql.html">translate_sql()</a></code> takes an optional <code>con</code>
parameter. If not supplied, this causes dbplyr to generate
(approximately) SQL-92 compliant SQL. If supplied, dbplyr uses
<code><a href="../reference/db-sql.html">sql_translation()</a></code> to look up a custom environment which
makes it possible for different databases to generate slightly different
SQL: see <code><a href="../articles/new-backend.html">vignette("new-backend")</a></code> for more details. You can
use the various simulate helpers to see the translations used by
different backends:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2L</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; POWER(`x`, 2)</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2L</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/backend-sqlite.html">simulate_sqlite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; POWER(`x`, 2)</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2L</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/backend-access.html">simulate_access</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; `x` ^ 2</span></span></code></pre></div>
<p>Perfect translation is not possible because databases don’t have all
the functions that R does. The goal of dbplyr is to provide a semantic
rather than a literal translation: what you mean, rather than precisely
what is done. In fact, even for functions that exist both in databases
and in R, you shouldn’t expect results to be identical; database
programmers have different priorities than R core programmers. For
example, in R in order to get a higher level of numerical accuracy,
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> loops through the data twice. R’s
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> also provides a <code>trim</code> option for
computing trimmed means; this is something that databases do not
provide.</p>
<p>If you’re interested in how <code><a href="../reference/translate_sql.html">translate_sql()</a></code> is
implemented, the basic techniques that underlie the implementation of
<code><a href="../reference/translate_sql.html">translate_sql()</a></code> are described in <a href="https://adv-r.hadley.nz/translation.html" class="external-link">“Advanced R”</a>.</p>
<div class="section level2">
<h2 id="basic-differences">Basic differences<a class="anchor" aria-label="anchor" href="#basic-differences"></a>
</h2>
<p>The following examples work through some of the basic differences
between R and SQL.</p>
<ul>
<li>
<p><code>"</code> and <code>'</code> mean different things</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In SQLite variable names are escaped by double quotes:</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; `x`</span></span>
<span><span class="co"># And strings are escaped by single quotes</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="st">"x"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; 'x'</span></span></code></pre></div>
</li>
<li>
<p>And some functions have different argument orders:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; SUBSTR(`x`, 5, 6)</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">10</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; LOG(10.0, `x`)</span></span></code></pre></div>
</li>
<li>
<p>R and SQL have different defaults for integers and reals. In R, 1
is a real, and 1L is an integer. In SQL, 1 is an integer, and 1.0 is a
real.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fl">1</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; 1.0</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fl">1L</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; 1</span></span></code></pre></div>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="known-functions">Known functions<a class="anchor" aria-label="anchor" href="#known-functions"></a>
</h2>
<div class="section level3">
<h3 id="mathematics">Mathematics<a class="anchor" aria-label="anchor" href="#mathematics"></a>
</h3>
<ul>
<li>basic math operators: <code>+</code>, <code>-</code>,
<code>*</code>, <code>/</code>, <code>^</code>
</li>
<li>trigonometry: <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">acos()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">asin()</a></code>,
<code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">atan()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">atan2()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos()</a></code>,
<code>cot()</code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">tan()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin()</a></code>
</li>
<li>hypergeometric: <code><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">cosh()</a></code>, <code>coth()</code>,
<code><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">sinh()</a></code>, <code><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">tanh()</a></code>
</li>
<li>logarithmic: <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log()</a></code>, <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10()</a></code>,
<code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code>
</li>
<li>misc: <code><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs()</a></code>, <code><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling()</a></code>,
<code><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt()</a></code>, <code><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign()</a></code>, <code><a href="https://rdrr.io/r/base/Round.html" class="external-link">round()</a></code>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="modulo-arithmetic">Modulo arithmetic<a class="anchor" aria-label="anchor" href="#modulo-arithmetic"></a>
</h2>
<p>dbplyr translates <code>%%</code> to the SQL equivalents but note
that it’s not precisely the same: most databases use truncated division
where the modulo operator takes the sign of the dividend, where R using
the mathematically preferred floored division with the modulo sign
taking the sign of the divisor.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">10L</span>, <span class="op">-</span><span class="fl">10L</span>, <span class="op">-</span><span class="fl">10L</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="op">-</span><span class="fl">3L</span>, <span class="fl">3L</span>, <span class="op">-</span><span class="fl">3L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/memdb_frame.html">tbl_memdb</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;       x     y `x%%y`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    10     3      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    10    -<span style="color: #BB0000;">3</span>     -<span style="color: #BB0000;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   -<span style="color: #BB0000;">10</span>     3      2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   -<span style="color: #BB0000;">10</span>    -<span style="color: #BB0000;">3</span>     -<span style="color: #BB0000;">1</span></span></span>
<span><span class="va">mf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [?? x 3]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.50.3 [:memory:]</span></span></span>
<span><span class="co">#&gt;       x     y `x%%y`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    10     3      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    10    -<span style="color: #BB0000;">3</span>      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   -<span style="color: #BB0000;">10</span>     3     -<span style="color: #BB0000;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   -<span style="color: #BB0000;">10</span>    -<span style="color: #BB0000;">3</span>     -<span style="color: #BB0000;">1</span></span></span></code></pre></div>
<p>dbplyr no longer translates <code>%/%</code> because there’s no
robust cross-database translation available.</p>
<div class="section level3">
<h3 id="logical-comparisons">Logical comparisons<a class="anchor" aria-label="anchor" href="#logical-comparisons"></a>
</h3>
<ul>
<li>logical comparisons: <code>&lt;</code>, <code>&lt;=</code>,
<code>!=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>==</code>,
<code>%in%</code>
</li>
<li>boolean operations: <code>&amp;</code>, <code>&amp;&amp;</code>,
<code>|</code>, <code>||</code>, <code>!</code>, <code><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor()</a></code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="aggregation">Aggregation<a class="anchor" aria-label="anchor" href="#aggregation"></a>
</h3>
<p>All databases provide translation for the basic aggregations:
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>,
<code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max()</a></code>, <code><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd()</a></code>, <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code>. Databases
automatically drop NULLs (their equivalent of missing values) whereas in
R you have to ask nicely. The aggregation functions warn you about this
important difference:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Missing values are always removed in SQL aggregation functions.</span></span>
<span><span class="co">#&gt; Use `na.rm = TRUE` to silence this warning</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; &lt;SQL&gt; AVG(`x`) OVER ()</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; AVG(`x`) OVER ()</span></span></code></pre></div>
<p>Note that, by default, <code>translate()</code> assumes that the call
is inside a <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code> or <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code> and generates
a window translation. If you want to see the equivalent
<code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise()</a></code>/aggregation translation, use
<code>window = FALSE</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, window <span class="op">=</span> <span class="cn">FALSE</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; AVG(`x`)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="conditional-evaluation">Conditional evaluation<a class="anchor" aria-label="anchor" href="#conditional-evaluation"></a>
</h3>
<p><code>if</code> and <code><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch()</a></code> are translated to
<code>CASE WHEN</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="kw">if</span> <span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">)</span> <span class="st">"big"</span> <span class="kw">else</span> <span class="st">"small"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; CASE WHEN (`x` &gt; 5.0) THEN 'big' WHEN NOT (`x` &gt; 5.0) THEN 'small' END</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">x</span>, a <span class="op">=</span> <span class="fl">1L</span>, b <span class="op">=</span> <span class="fl">2L</span>, <span class="fl">3L</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; CASE `x` WHEN ('a') THEN (1) WHEN ('b') THEN (2) ELSE (3) END</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="string-manipulation">String manipulation<a class="anchor" aria-label="anchor" href="#string-manipulation"></a>
</h3>
</div>
<div class="section level3">
<h3 id="datetime">Date/time<a class="anchor" aria-label="anchor" href="#datetime"></a>
</h3>
<ul>
<li>string functions: <code>tolower</code>, <code>toupper</code>,
<code>trimws</code>, <code>nchar</code>, <code>substr</code>
</li>
<li>coerce types: <code>as.numeric</code>, <code>as.integer</code>,
<code>as.character</code>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="unknown-functions">Unknown functions<a class="anchor" aria-label="anchor" href="#unknown-functions"></a>
</h2>
<p>Any function that dbplyr doesn’t know how to convert is left as is.
This means that database functions that are not covered by dbplyr can
often be used directly via <code><a href="../reference/translate_sql.html">translate_sql()</a></code>.</p>
<div class="section level3">
<h3 id="prefix-functions">Prefix functions<a class="anchor" aria-label="anchor" href="#prefix-functions"></a>
</h3>
<p>Any function that dbplyr doesn’t know about will be left as is:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu">foofify</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; foofify(`x`, `y`)</span></span></code></pre></div>
<p>Because SQL functions are generally case insensitive, I recommend
using upper case when you’re using SQL functions in R code. That makes
it easier to spot that you’re doing something unusual:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu">FOOFIFY</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; FOOFIFY(`x`, `y`)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="infix-functions">Infix functions<a class="anchor" aria-label="anchor" href="#infix-functions"></a>
</h3>
<p>As well as prefix functions (where the name of the function comes
before the arguments), dbplyr also translates infix functions. That
allows you to use expressions like <code>LIKE</code>, which does a
limited form of pattern matching:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%LIKE%</span> <span class="st">"%foo%"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; `x` LIKE '%foo%'</span></span></code></pre></div>
<p>Or use <code>||</code> for string concatenation (although most
backends will translate <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste()</a></code> and <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0()</a></code>
for you):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="va">y</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; `x` || `y`</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="special-forms">Special forms<a class="anchor" aria-label="anchor" href="#special-forms"></a>
</h3>
<p>SQL functions tend to have a greater variety of syntax than R. That
means there are a number of expressions that can’t be translated
directly from R code. To insert these in your own queries, you can use
literal SQL inside <code><a href="../reference/sql.html">sql()</a></code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"x!"</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; x!</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"ANY VALUES(1, 2, 3)"</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; `x` = ANY VALUES(1, 2, 3)</span></span></code></pre></div>
<p>This gives you a lot of freedom to generate the SQL you need:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/memdb_frame.html">memdb_frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>factorial <span class="op">=</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"x!"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> x!<span style="color: #0000BB;"> AS </span>`factorial`</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> `dbplyr_uR8HfdVHIy`</span></span>
<span></span>
<span><span class="va">mf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>factorial <span class="op">=</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"CAST(x AS FLOAT)"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/explain.html" class="external-link">show_query</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> CAST(x AS FLOAT)<span style="color: #0000BB;"> AS </span>`factorial`</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> `dbplyr_uR8HfdVHIy`</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="error-for-unknown-translations">Error for unknown translations<a class="anchor" aria-label="anchor" href="#error-for-unknown-translations"></a>
</h3>
<p>If needed, you can also use the <code>dplyr.strict_sql</code> option
to force dbplyr to error if it doesn’t know how to translate a
function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>dplyr.strict_sql <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu">glob</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `glob()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Don't know how to translate `glob()`</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="window-functions">Window functions<a class="anchor" aria-label="anchor" href="#window-functions"></a>
</h2>
<p>Things get a little trickier with window functions, because SQL’s
window functions are considerably more expressive than the specific
variants provided by base R or dplyr. They have the form
<code>[expression] OVER ([partition clause] [order clause] [frame_clause])</code>:</p>
<ul>
<li><p>The <strong>expression</strong> is a combination of variable
names and window functions. Support for window functions varies from
database to database, but most support the ranking functions,
<code>lead</code>, <code>lag</code>, <code>nth</code>,
<code>first</code>, <code>last</code>, <code>count</code>,
<code>min</code>, <code>max</code>, <code>sum</code>, <code>avg</code>
and <code>stddev</code>.</p></li>
<li><p>The <strong>partition clause</strong> specifies how the window
function is broken down over groups. It plays an analogous role to
<code>GROUP BY</code> for aggregate functions, and
<code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> in dplyr. It is possible for different window
functions to be partitioned into different groups, but not all databases
support it, and neither does dplyr.</p></li>
<li><p>The <strong>order clause</strong> controls the ordering (when it
makes a difference). This is important for the ranking functions since
it specifies which variables to rank by, but it’s also needed for
cumulative functions and lead. Whenever you’re thinking about before and
after in SQL, you must always tell it which variable defines the order.
If the order clause is missing when needed, some databases fail with an
error message while others return non-deterministic results.</p></li>
<li>
<p>The <strong>frame clause</strong> defines which rows, or
<strong>frame</strong>, that are passed to the window function,
describing which rows (relative to the current row) should be included.
The frame clause provides two offsets which determine the start and end
of frame. There are three special values: -Inf means to include all
preceding rows (in SQL, “unbounded preceding”), 0 means the current row
(“current row”), and Inf means all following rows (“unbounded
following”). The complete set of options is comprehensive, but fairly
confusing, and is summarised visually below.</p>
<p><img src="windows.png" alt="A visual summary of the frame clause using the real line labelled with negative infinity, -3, -2, -1, 0, 1, 2, 3, infinity. The most important clauses are rolling, cumulative, and recycling.  Rolling, e.g. between 1 preceding and 1, following, run from  -1 to -1. Cumulative, between unbounded preceding and  current row, runs from negative infinity to 0. Recycled,  between unbound preceeding and unbound following, runs from  negative infinity to positive infinity." width="100%"></p>
<p>Of the many possible specifications, only three are commonly used.
They select between aggregation variants:</p>
<ul>
<li><p>Recycled:
<code>BETWEEN UNBOUND PRECEDING AND UNBOUND FOLLOWING</code></p></li>
<li><p>Cumulative:
<code>BETWEEN UNBOUND PRECEDING AND CURRENT ROW</code></p></li>
<li><p>Rolling:
<code>BETWEEN 2 PRECEDING AND 2 FOLLOWING</code></p></li>
</ul>
<p>dbplyr generates the frame clause based on whether you’re using a
recycled aggregate or a cumulative aggregate.</p>
</li>
</ul>
<p>To see how individual window functions are translated to SQL, we can
again use <code><a href="../reference/translate_sql.html">translate_sql()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; AVG(`G`) OVER ()</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; CASE</span></span>
<span><span class="co">#&gt; WHEN (NOT((`G` IS NULL))) THEN RANK() OVER (PARTITION BY (CASE WHEN ((`G` IS NULL)) THEN 1 ELSE 0 END) ORDER BY `G`)</span></span>
<span><span class="co">#&gt; END</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ntile.html" class="external-link">ntile</a></span><span class="op">(</span><span class="va">G</span>, <span class="fl">2</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; NTILE(2) OVER (ORDER BY `G`)</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; LAG(`G`, 1, NULL) OVER ()</span></span></code></pre></div>
<p>If the tbl has been grouped or arranged previously in the pipeline,
then dplyr will use that information to set the “partition by” and
“order by” clauses. For interactive exploration, you can achieve the
same effect by setting the <code>vars_group</code> and
<code>vars_order</code> arguments to <code><a href="../reference/translate_sql.html">translate_sql()</a></code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/cumall.html" class="external-link">cummean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span>, vars_order <span class="op">=</span> <span class="st">"year"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; AVG(`G`) OVER (ORDER BY `year` ROWS UNBOUNDED PRECEDING)</span></span>
<span><span class="fu"><a href="../reference/translate_sql.html">translate_sql</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="op">)</span>, vars_group <span class="op">=</span> <span class="st">"ID"</span>, con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; RANK() OVER (PARTITION BY `ID`)</span></span></code></pre></div>
<p>There are some challenges when translating window functions between R
and SQL, because dbplyr tries to keep the window functions as similar as
possible to both the existing R analogues and to the SQL functions. This
means that there are three ways to control the order clause depending on
which window function you’re using:</p>
<ul>
<li><p>For ranking functions, the ordering variable is the first
argument: <code>rank(x)</code>, <code>ntile(y, 2)</code>. If omitted or
<code>NULL</code>, will use the default ordering associated with the tbl
(as set by <code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange()</a></code>).</p></li>
<li><p>Accumulating aggregates only take a single argument (the vector
to aggregate). To control ordering, use
<code><a href="https://dplyr.tidyverse.org/reference/order_by.html" class="external-link">order_by()</a></code>.</p></li>
<li><p>Aggregates implemented in dplyr (<code>lead</code>,
<code>lag</code>, <code>nth_value</code>, <code>first_value</code>,
<code>last_value</code>) have an <code>order_by</code> argument. Supply
it to override the default ordering.</p></li>
</ul>
<p>The three options are illustrated in the snippet below:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">players</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">min_rank</a></span><span class="op">(</span><span class="va">yearID</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/order_by.html" class="external-link">order_by</a></span><span class="op">(</span><span class="va">yearID</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead</a></span><span class="op">(</span><span class="va">G</span>, order_by <span class="op">=</span> <span class="va">yearID</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Currently there is no way to order by multiple variables, except by
setting the default ordering with <code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange()</a></code>. This will be
added in a future release.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, Maximilian Girlich, Edgar Ruiz, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
