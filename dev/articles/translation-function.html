<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Function translation • dbplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Function translation">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="dbplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dbplyr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.5.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dbplyr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/new-backend.html">Adding a new DBI backend</a></li>
    <li><a class="dropdown-item" href="../articles/reprex.html">Reprexes for dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/translation-function.html">Function translation</a></li>
    <li><a class="dropdown-item" href="../articles/translation-verb.html">Verb translation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2024/04/dbplyr-2-5-0/">Version 2.5.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/dbplyr-2-4-0/">Version 2.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/01/dbplyr-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2022/06/dbplyr-2-2-0/">Version 2.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/02/dplyr-backends/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/11/dbplyr-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/dbplyr-1-4-0/">Version 1.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/01/dbplyr-1-3-0/">Version 1.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/01/dbplyr-1-2/">Version 1.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2017/06/27/dbplyr-1-1-0/">Version 1.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/dbplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Function translation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/main/vignettes/translation-function.Rmd" class="external-link"><code>vignettes/translation-function.Rmd</code></a></small>
      <div class="d-none name"><code>translation-function.Rmd</code></div>
    </div>

    
    
<p>There are two parts to dbplyr SQL translation: translating dplyr
verbs, and translating expressions within those verbs. This vignette
describes how individual expressions (function calls) are translated;
<code><a href="../articles/translation-verb.html">vignette("translation-verb")</a></code> describes how entire verbs are
translated.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="getting-started-with-translations">Getting started with translations<a class="anchor" aria-label="anchor" href="#getting-started-with-translations"></a>
</h2>
<p>In this vignette, I’ll use <code><a href="../reference/tbl_lazy.html">lazy_frame()</a></code> to create a toy
lazy table that allows us to see the translation without needing to
connect to a real database:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_lazy.html">lazy_frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">2</span>, g <span class="op">=</span> <span class="st">"a"</span><span class="op">)</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="va">y</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*, ("x" + "y") / 2.0<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>The default <code><a href="../reference/tbl_lazy.html">lazy_frame()</a></code> uses a generic database that
generates (approximately) SQL-92 compliant SQL. You can use
<code>simulate_*()</code> connections to see the translations used by
different backends. Different databases generate slightly different SQL;
see <code><a href="../articles/new-backend.html">vignette("new-backend")</a></code> for more details.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf_sqlite</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_lazy.html">lazy_frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/backend-sqlite.html">simulate_sqlite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lf_access</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_lazy.html">lazy_frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/backend-access.html">simulate_access</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lf_sqlite</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> POWER(`x`, 2.0)<span style="color: #0000BB;"> AS </span>`z`</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> `df`</span></span>
<span><span class="va">lf_access</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x" ^ 2.0<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>One key difference between dbplyr-generated SQL and hand-written SQL
is that dbplyr always quotes all table and column names. This is verbose
but necessary because column names in database tables can be any string,
including SQL reserved words like <code>select</code> or
<code>if</code>. Quoting all names ensures that dbplyr-generated SQL
always works regardless of the table and column names involved.</p>
<p>In general, perfect translation is not possible because databases
don’t have all the functions that R does. The goal of dbplyr is to
provide a semantic rather than a literal translation: what you mean,
rather than precisely what is done. In fact, even for functions that
exist both in databases and in R, you shouldn’t expect results to be
identical; database programmers have different priorities than R core
programmers. For example, in R in order to get a higher level of
numerical accuracy, <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> loops through the data twice.
R’s <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> also provides a <code>trim</code> option for
computing trimmed means; this is something that databases do not
provide.</p>
<p>If you’re interested in how <code><a href="../reference/translate_sql.html">translate_sql()</a></code> is
implemented, the basic techniques that underlie the implementation of
<code><a href="../reference/translate_sql.html">translate_sql()</a></code> are described in <a href="https://adv-r.hadley.nz/translation.html" class="external-link">“Advanced R”</a>.</p>
</div>
<div class="section level2">
<h2 id="basic-differences">Basic differences<a class="anchor" aria-label="anchor" href="#basic-differences"></a>
</h2>
<p>There are two fundamental differences between R and SQL:</p>
<ul>
<li>
<p><code>"</code> and <code>'</code> mean different things. R can
use either <code>"</code> or <code>'</code> for strings, but in ANSI
SQL, must be <code>"</code> used for names and must be <code>'</code>
used for strings.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="st">"x"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("x" = 'x')</span></span></code></pre></div>
</li>
<li>
<p>R and SQL have different defaults for integers and reals. In R, 1
is a real, and 1L is an integer. In SQL, 1 is an integer, and 1.0 is a
real.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> 1.0<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> 1<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="known-functions">Known functions<a class="anchor" aria-label="anchor" href="#known-functions"></a>
</h2>
<div class="section level3">
<h3 id="mathematics">Mathematics<a class="anchor" aria-label="anchor" href="#mathematics"></a>
</h3>
<ul>
<li>basic math operators: <code>+</code>, <code>-</code>,
<code>*</code>, <code>/</code>, <code>^</code>
</li>
<li>trigonometry: <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">acos()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">asin()</a></code>,
<code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">atan()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">atan2()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos()</a></code>,
<code>cot()</code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">tan()</a></code>, <code><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin()</a></code>
</li>
<li>hyperbolic: <code><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">cosh()</a></code>, <code>coth()</code>,
<code><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">sinh()</a></code>, <code><a href="https://rdrr.io/r/base/Hyperbolic.html" class="external-link">tanh()</a></code>
</li>
<li>logarithmic: <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log()</a></code>, <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10()</a></code>,
<code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code>
</li>
<li>misc: <code><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs()</a></code>, <code><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling()</a></code>,
<code><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor()</a></code>, <code><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt()</a></code>, <code><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign()</a></code>,
<code><a href="https://rdrr.io/r/base/Round.html" class="external-link">round()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span> <span class="op">/</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">y</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x", (POWER("x", 2.0)) + POWER("y", 2.0)<span style="color: #0000BB;"> AS </span>"y"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> "x" / 2.0<span style="color: #0000BB;"> AS </span>"x", "y", "g"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; ) <span style="color: #0000BB;">AS </span>"q01"</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> LN("x")<span style="color: #0000BB;"> AS </span>"x", ROUND("y", 1)<span style="color: #0000BB;"> AS </span>"y"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="modulo-arithmetic">Modulo arithmetic<a class="anchor" aria-label="anchor" href="#modulo-arithmetic"></a>
</h3>
<p>dbplyr translates <code>%%</code> to the SQL equivalents but note
that it’s not precisely the same: most databases use truncated division
where the modulo operator takes the sign of the dividend, where R using
the mathematically preferred floored division with the modulo sign
taking the sign of the divisor.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">10L</span>, <span class="op">-</span><span class="fl">10L</span>, <span class="op">-</span><span class="fl">10L</span><span class="op">)</span>,</span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3L</span>, <span class="op">-</span><span class="fl">3L</span>, <span class="fl">3L</span>, <span class="op">-</span><span class="fl">3L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="fu"><a href="../reference/memdb.html">memdb</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;       x     y `x%%y`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    10     3      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    10    -<span style="color: #BB0000;">3</span>     -<span style="color: #BB0000;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   -<span style="color: #BB0000;">10</span>     3      2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   -<span style="color: #BB0000;">10</span>    -<span style="color: #BB0000;">3</span>     -<span style="color: #BB0000;">1</span></span></span>
<span><span class="va">db</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A query:  ?? x 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.51.1 [:memory:]</span></span></span>
<span><span class="co">#&gt;       x     y `x%%y`</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    10     3      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>    10    -<span style="color: #BB0000;">3</span>      1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   -<span style="color: #BB0000;">10</span>     3     -<span style="color: #BB0000;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>   -<span style="color: #BB0000;">10</span>    -<span style="color: #BB0000;">3</span>     -<span style="color: #BB0000;">1</span></span></span></code></pre></div>
<p>dbplyr no longer translates <code>%/%</code> because there’s no
robust cross-database translation available.</p>
</div>
<div class="section level3">
<h3 id="logical-comparisons-and-boolean-operations">Logical comparisons and boolean operations<a class="anchor" aria-label="anchor" href="#logical-comparisons-and-boolean-operations"></a>
</h3>
<ul>
<li>logical comparisons: <code>&lt;</code>, <code>&lt;=</code>,
<code>!=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>==</code>,
<code>%in%</code>, <code><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between()</a></code>
</li>
<li>boolean operations: <code>&amp;</code>, <code>&amp;&amp;</code>,
<code>|</code>, <code>||</code>, <code>!</code>, <code><a href="https://rdrr.io/r/base/Logic.html" class="external-link">xor()</a></code>
</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">|</span> <span class="va">y</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("x" &gt; 5.0 OR "y" = 2.0)</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("x" IN (1.0, 2.0, 3.0))</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html" class="external-link">between</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("x" BETWEEN 1.0 AND 5.0)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="bitwise-operations">Bitwise operations<a class="anchor" aria-label="anchor" href="#bitwise-operations"></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwNot()</a></code>, <code><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwAnd()</a></code>,
<code><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwOr()</a></code>, <code><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwXor()</a></code>,
<code><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftL()</a></code>, and <code><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftR()</a></code> are all
supported:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwAnd</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">3L</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/bitwise.html" class="external-link">bitwShiftL</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x", "x" &lt;&lt; 2<span style="color: #0000BB;"> AS </span>"y"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> "x" &amp; 3<span style="color: #0000BB;"> AS </span>"x", "y", "g"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; ) <span style="color: #0000BB;">AS </span>"q01"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="type-coercion">Type coercion<a class="anchor" aria-label="anchor" href="#type-coercion"></a>
</h3>
<p>Type coercion functions use the corresponding SQL <code>CAST()</code>
call:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x", CAST("x" AS TEXT)<span style="color: #0000BB;"> AS </span>"y"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> CAST("y" AS INTEGER)<span style="color: #0000BB;"> AS </span>"x", "y", "g"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; ) <span style="color: #0000BB;">AS </span>"q01"</span></span></code></pre></div>
<ul>
<li>integer types: <code><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer()</a></code>,
<code>as.integer64()</code>
</li>
<li>floating point: <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric()</a></code>,
<code><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double()</a></code>
</li>
<li>character: <code><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character()</a></code>
</li>
<li>logical: <code><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical()</a></code>
</li>
<li>date/time: <code><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date()</a></code>, <code><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct()</a></code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="nullna-handling">
<code>NULL</code>/<code>NA</code> handling<a class="anchor" aria-label="anchor" href="#nullna-handling"></a>
</h3>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na()</a></code>, <code><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null()</a></code>: test for
<code>NULL</code>.</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/na_if.html" class="external-link">na_if()</a></code>: replace a value with <code>NULL</code>.</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce()</a></code>: replace <code>NULL</code> with a default
value.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> (NOT(("x" IS NULL)))</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> COALESCE("x", 0)<span style="color: #0000BB;"> AS </span>"x"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/na_if.html" class="external-link">na_if</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> NULLIF("x", 0)<span style="color: #0000BB;"> AS </span>"x"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregation">Aggregation<a class="anchor" aria-label="anchor" href="#aggregation"></a>
</h3>
<p>All databases provide translation for the basic aggregations:
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>,
<code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max()</a></code>. Databases automatically drop NULLs (their equivalent
of missing values) whereas in R you have to ask nicely. The aggregation
functions warn you about this important difference:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Missing values are always removed in SQL aggregation functions.</span></span>
<span><span class="co">#&gt; Use `na.rm = TRUE` to silence this warning</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> AVG("x")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> AVG("x")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>Note that aggregation functions used inside <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code> or
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code> generate a window translation:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*, AVG("x") OVER ()<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x", "y", "g"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> (</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">SELECT</span> "df".*, AVG("x") OVER ()<span style="color: #0000BB;"> AS </span>"col01"</span></span>
<span><span class="co">#&gt;   <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; ) <span style="color: #0000BB;">AS </span>"q01"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("col01" &gt; 0.0)</span></span></code></pre></div>
<p>Most backends also support:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd()</a></code>, <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code>, <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor()</a></code>,
<code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov()</a></code>
</li>
<li>
<code><a href="https://rdrr.io/r/stats/median.html" class="external-link">median()</a></code>, <code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code>
</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct()</a></code>
</li>
<li>
<code><a href="https://rdrr.io/r/base/all.html" class="external-link">all()</a></code>, <code><a href="https://rdrr.io/r/base/any.html" class="external-link">any()</a></code>
</li>
<li><code>str_flatten()</code></li>
</ul>
</div>
<div class="section level3">
<h3 id="conditional-evaluation">Conditional evaluation<a class="anchor" aria-label="anchor" href="#conditional-evaluation"></a>
</h3>
<p><code>if</code>, <code><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse()</a></code>, and <code><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else()</a></code>
are translated to <code>CASE WHEN</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">5</span>, <span class="st">"big"</span>, <span class="st">"small"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> CASE WHEN ("x" &gt; 5.0) THEN 'big' WHEN NOT ("x" &gt; 5.0) THEN 'small' END<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/case_match.html" class="external-link">case_match()</a></code>, and
<code><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch()</a></code> are also supported:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">10</span> <span class="op">~</span> <span class="st">"medium"</span>,</span>
<span>    <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">30</span> <span class="op">~</span> <span class="st">"big"</span>, </span>
<span>    .default <span class="op">=</span> <span class="st">"small"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   "df".*,</span></span>
<span><span class="co">#&gt;   CASE</span></span>
<span><span class="co">#&gt; WHEN ("x" &gt; 10.0) THEN 'medium'</span></span>
<span><span class="co">#&gt; WHEN ("x" &gt; 30.0) THEN 'big'</span></span>
<span><span class="co">#&gt; ELSE 'small'</span></span>
<span><span class="co">#&gt; END<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">g</span>, a <span class="op">=</span> <span class="fl">1L</span>, b <span class="op">=</span> <span class="fl">2L</span>, <span class="fl">3L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   "df".*,</span></span>
<span><span class="co">#&gt;   CASE "g" WHEN ('a') THEN (1) WHEN ('b') THEN (2) ELSE (3) END<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="string-functions">String functions<a class="anchor" aria-label="anchor" href="#string-functions"></a>
</h3>
<p>Base R string functions and their stringr equivalents are widely
supported:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar()</a></code>, <code>str_length()</code>
</li>
<li>
<code><a href="https://rdrr.io/r/base/chartr.html" class="external-link">tolower()</a></code>, <code><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper()</a></code>,
<code>str_to_lower()</code>, <code>str_to_upper()</code>,
<code>str_to_title()</code>
</li>
<li>
<code><a href="https://rdrr.io/r/base/trimws.html" class="external-link">trimws()</a></code>, <code>str_trim()</code>
</li>
<li>
<code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste()</a></code>, <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0()</a></code>,
<code>str_c()</code>
</li>
<li>
<code><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr()</a></code>, <code><a href="https://rdrr.io/r/base/substr.html" class="external-link">substring()</a></code>,
<code>str_sub()</code>
</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">g</span>, <span class="st">" dog"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> CONCAT_WS('', "g", ' dog')<span style="color: #0000BB;"> AS </span>"x"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">g</span>, <span class="fl">1L</span>, <span class="fl">2L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> SUBSTR("g", 1, 2)<span style="color: #0000BB;"> AS </span>"x"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>Many backends also support regular expression functions like
<code>str_detect()</code>, <code>str_replace()</code>,
<code>str_replace_all()</code>, <code>str_remove()</code>,
<code>str_remove_all()</code>, <code>str_squish()</code>, and
<code>str_like()</code>. Support varies by backend; see the individual
backend documentation for details.</p>
</div>
<div class="section level3">
<h3 id="datetime-functions">Date/time functions<a class="anchor" aria-label="anchor" href="#datetime-functions"></a>
</h3>
<p>dbplyr supports many lubridate functions for extracting date
components:</p>
<ul>
<li>
<code>today()</code>, <code>now()</code>
</li>
<li>
<code>year()</code>, <code>month()</code>, <code>day()</code>,
<code>mday()</code>, <code>hour()</code>, <code>minute()</code>,
<code>second()</code>
</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_lazy.html">lazy_frame</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lf_dt</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>  year <span class="op">=</span> <span class="fu">year</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>,</span>
<span>  month <span class="op">=</span> <span class="fu">month</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>,</span>
<span>  day <span class="op">=</span> <span class="fu">day</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   EXTRACT(year FROM "dt")<span style="color: #0000BB;"> AS </span>"year",</span></span>
<span><span class="co">#&gt;   EXTRACT(month FROM "dt")<span style="color: #0000BB;"> AS </span>"month",</span></span>
<span><span class="co">#&gt;   EXTRACT(day FROM "dt")<span style="color: #0000BB;"> AS </span>"day"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>Some backends also support additional lubridate functions including
<code>yday()</code>, <code>wday()</code>, <code>week()</code>,
<code>isoweek()</code>, <code>quarter()</code>, <code>isoyear()</code>,
<code>floor_date()</code>, and period functions like
<code>seconds()</code>, <code>minutes()</code>, <code>hours()</code>,
<code>days()</code>, <code>weeks()</code>, <code><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months()</a></code>,
<code>years()</code>.</p>
<p>Several backends (including PostgreSQL, Snowflake, SQL Server,
Redshift, and Spark SQL) support <a href="https://clock.r-lib.org" class="external-link">clock</a> functions for date
arithmetic.</p>
<ul>
<li>
<code>add_days()</code>, <code>add_years()</code>
</li>
<li><code>date_build()</code></li>
<li>
<code>get_year()</code>, <code>get_month()</code>,
<code>get_day()</code>
</li>
<li><code>date_count_between()</code></li>
<li><code><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime()</a></code></li>
</ul>
<p>clock functions tend to be easier to translate than lubridate
functions because they are more specific.</p>
</div>
<div class="section level3">
<h3 id="other-functions">Other functions<a class="anchor" aria-label="anchor" href="#other-functions"></a>
</h3>
<ul>
<li>
<code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax()</a></code> for parallel min/max</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc()</a></code> for descending order</li>
<li>
<code><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut()</a></code> for binning numeric values into categories</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="unknown-functions">Unknown functions<a class="anchor" aria-label="anchor" href="#unknown-functions"></a>
</h2>
<p>Any function that dbplyr doesn’t know how to convert is left as is.
This means that database functions that are not covered by dbplyr can
often be used directly.</p>
<div class="section level3">
<h3 id="prefix-functions">Prefix functions<a class="anchor" aria-label="anchor" href="#prefix-functions"></a>
</h3>
<p>Any function that dbplyr doesn’t know about will be left as is:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu">foofify</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*, foofify("x", "y")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>But to make it clear that you’re deliberately calling a SQL function,
we recommend using the <code>.sql</code> pronoun:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">.sql</span><span class="op">$</span><span class="fu">foofify</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> foofify("x", "y")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>If you’re working inside a package, this also makes it easier to
avoid <code>R CMD CHECK</code> notes. Just import <code>.sql</code> from
dbplyr using a roxygen2 tag like
<code>@importFrom dbplyr .sql</code></p>
</div>
<div class="section level3">
<h3 id="infix-functions">Infix functions<a class="anchor" aria-label="anchor" href="#infix-functions"></a>
</h3>
<p>As well as prefix functions (where the name of the function comes
before the arguments), dbplyr also translates infix functions. That
allows you to use expressions like <code>LIKE</code>, which does a
limited form of pattern matching:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">x</span> <span class="op">%LIKE%</span> <span class="st">"%foo%"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("x" LIKE '%foo%')</span></span></code></pre></div>
<p>You can also use <code>str_like()</code> for this common case:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">str_like</span><span class="op">(</span><span class="va">x</span>, <span class="st">"%foo%"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">WHERE</span> ("x" LIKE '%foo%')</span></span></code></pre></div>
<p>You could use <code>%||%</code> for string concatenation, but in most
cases it’s more R-like to use <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste()</a></code> or
<code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x" || "y"<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> CONCAT_WS('', "x", "y")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> CONCAT_WS(' ', "x", "y")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="special-forms">Special forms<a class="anchor" aria-label="anchor" href="#special-forms"></a>
</h3>
<p>SQL functions tend to have a greater variety of syntax than R. That
means there are a number of expressions that can’t be translated
directly from R code. To insert these in your own queries, you can use
literal SQL inside <code><a href="../reference/sql.html">sql()</a></code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"x!"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> x!<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">x</span> <span class="op">==</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"ANY VALUES(1, 2, 3)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "x" = ANY VALUES(1, 2, 3)<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>This gives you a lot of freedom to generate the SQL you need:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>factorial <span class="op">=</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"x!"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> x!<span style="color: #0000BB;"> AS </span>"factorial"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span>factorial <span class="op">=</span> <span class="fu"><a href="../reference/sql.html">sql</a></span><span class="op">(</span><span class="st">"CAST(x AS FLOAT)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> CAST(x AS FLOAT)<span style="color: #0000BB;"> AS </span>"factorial"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="error-for-unknown-translations">Error for unknown translations<a class="anchor" aria-label="anchor" href="#error-for-unknown-translations"></a>
</h3>
<p>If needed, you can also use the <code>dplyr.strict_sql</code> option
to force dbplyr to error if it doesn’t know how to translate a
function:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>dplyr.strict_sql <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu">glob</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `glob()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Don't know how to translate `glob()`</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="window-functions">Window functions<a class="anchor" aria-label="anchor" href="#window-functions"></a>
</h2>
<p>Things get a little trickier with window functions, because SQL’s
window functions are considerably more expressive than the specific
variants provided by base R or dplyr. They have the form
<code>[expression] OVER ([partition clause] [order clause] [frame_clause])</code>:</p>
<ul>
<li>
<p>The <strong>expression</strong> is a combination of variable
names and window functions. Support for window functions varies from
database to database, but most support:</p>
<ul>
<li>ranking: <code><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">min_rank()</a></code>,
<code><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">dense_rank()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/percent_rank.html" class="external-link">percent_rank()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/percent_rank.html" class="external-link">cume_dist()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/ntile.html" class="external-link">ntile()</a></code>;</li>
<li>offsets: <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">last()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">nth()</a></code>;</li>
<li>aggregates: <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code>,
<code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/n_distinct.html" class="external-link">n_distinct()</a></code>;</li>
<li>cumulative: <code><a href="https://dplyr.tidyverse.org/reference/cumall.html" class="external-link">cummean()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum()</a></code>,
<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummin()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummax()</a></code>.</li>
</ul>
</li>
<li><p>The <strong>partition clause</strong> specifies how the window
function is broken down over groups. It plays an analogous role to
<code>GROUP BY</code> for aggregate functions, and
<code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> in dplyr. It is possible for different window
functions to be partitioned into different groups, but not all databases
support it, and neither does dplyr.</p></li>
<li><p>The <strong>order clause</strong> controls the ordering (when it
makes a difference). This is important for the ranking functions since
it specifies which variables to rank by, but it’s also needed for
cumulative functions and lead. Whenever you’re thinking about before and
after in SQL, you must always tell it which variable defines the order.
If the order clause is missing when needed, some databases fail with an
error message while others return non-deterministic results.</p></li>
<li>
<p>The <strong>frame clause</strong> defines which rows, or
<strong>frame</strong>, that are passed to the window function,
describing which rows (relative to the current row) should be included.
The frame clause provides two offsets which determine the start and end
of frame. There are three special values: -Inf means to include all
preceding rows (in SQL, “unbounded preceding”), 0 means the current row
(“current row”), and Inf means all following rows (“unbounded
following”). The complete set of options is comprehensive, but fairly
confusing, and is summarised visually below.</p>
<p><img src="windows.png" class="r-plt" alt="A visual summary of the frame clause using the real line labelled with negative infinity, -3, -2, -1, 0, 1, 2, 3, infinity. The most important clauses are rolling, cumulative, and recycling.  Rolling, e.g. between 1 preceding and 1, following, run from  -1 to -1. Cumulative, between unbounded preceding and  current row, runs from negative infinity to 0. Recycled,  between unbound preceeding and unbound following, runs from  negative infinity to positive infinity." width="100%"></p>
<p>Of the many possible specifications, only three are commonly used.
They select between aggregation variants:</p>
<ul>
<li><p>Recycled:
<code>BETWEEN UNBOUND PRECEDING AND UNBOUND FOLLOWING</code></p></li>
<li><p>Cumulative:
<code>BETWEEN UNBOUND PRECEDING AND CURRENT ROW</code></p></li>
<li><p>Rolling:
<code>BETWEEN 2 PRECEDING AND 2 FOLLOWING</code></p></li>
</ul>
<p>dbplyr generates the frame clause based on whether you’re using a
recycled aggregate or a cumulative aggregate.</p>
</li>
</ul>
<p>To see how individual window functions are translated to SQL, we can
use <code><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute()</a></code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_lazy.html">lazy_frame</a></span><span class="op">(</span>g <span class="op">=</span> <span class="fl">1</span>, year <span class="op">=</span> <span class="fl">2020</span>, id <span class="op">=</span> <span class="fl">3</span>, con <span class="op">=</span> <span class="fu"><a href="../reference/simulate_dbi.html">simulate_dbi</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>, </span>
<span>  rank <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">min_rank</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>, </span>
<span>  cumsum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>,</span>
<span>  lag <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Windowed expression `SUM("g")` does not have explicit order.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `arrange()`, `window_order()`, or `.order` to make</span></span>
<span><span class="co">#&gt;   deterministic.</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   AVG("g") OVER ()<span style="color: #0000BB;"> AS </span>"mean",</span></span>
<span><span class="co">#&gt;   CASE</span></span>
<span><span class="co">#&gt; WHEN (NOT(("g" IS NULL))) THEN RANK() OVER (PARTITION BY (CASE WHEN (("g" IS NULL)) THEN 1 ELSE 0 END) ORDER BY "g")</span></span>
<span><span class="co">#&gt; END<span style="color: #0000BB;"> AS </span>"rank",</span></span>
<span><span class="co">#&gt;   SUM("g") OVER (ROWS UNBOUNDED PRECEDING)<span style="color: #0000BB;"> AS </span>"cumsum",</span></span>
<span><span class="co">#&gt;   LAG("g", 1, NULL) OVER ()<span style="color: #0000BB;"> AS </span>"lag"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>If the lazy frame has been grouped or arranged previously in the
pipeline, then dbplyr will use that information to set the “partition
by” and “order by” clauses:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/cumall.html" class="external-link">cummean</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*, AVG("g") OVER (ORDER BY "year" ROWS UNBOUNDED PRECEDING)<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">ORDER BY</span> "year"</span></span>
<span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span> "df".*, RANK() OVER (PARTITION BY "id")<span style="color: #0000BB;"> AS </span>"z"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>There are some challenges when translating window functions between R
and SQL, because dbplyr tries to keep the window functions as similar as
possible to both the existing R analogues and to the SQL functions. This
means that there are three ways to control the order clause depending on
which window function you’re using:</p>
<ul>
<li><p>For ranking functions, the ordering variable is the first
argument: <code>rank(x)</code>, <code>ntile(y, 2)</code>. If omitted or
<code>NULL</code>, will use the default ordering associated with the tbl
(as set by <code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange()</a></code>).</p></li>
<li><p>Accumulating aggregates only take a single argument (the vector
to aggregate). To control ordering, use
<code><a href="https://dplyr.tidyverse.org/reference/order_by.html" class="external-link">order_by()</a></code>.</p></li>
<li><p>Aggregates implemented in dplyr (<code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">nth()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">last()</a></code>) have an <code>order_by</code> argument. Supply it
to override the default ordering.</p></li>
</ul>
<p>The three options are illustrated in the snippet below:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>  x1 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">min_rank</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>,</span>
<span>  x2 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/order_by.html" class="external-link">order_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  x3 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lead</a></span><span class="op">(</span><span class="va">g</span>, order_by <span class="op">=</span> <span class="va">year</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">SELECT</span></span></span>
<span><span class="co">#&gt;   CASE</span></span>
<span><span class="co">#&gt; WHEN (NOT(("g" IS NULL))) THEN RANK() OVER (PARTITION BY (CASE WHEN (("g" IS NULL)) THEN 1 ELSE 0 END) ORDER BY "g")</span></span>
<span><span class="co">#&gt; END<span style="color: #0000BB;"> AS </span>"x1",</span></span>
<span><span class="co">#&gt;   SUM("g") OVER (ORDER BY "year" ROWS UNBOUNDED PRECEDING)<span style="color: #0000BB;"> AS </span>"x2",</span></span>
<span><span class="co">#&gt;   LEAD("g", 1, NULL) OVER (ORDER BY "year")<span style="color: #0000BB;"> AS </span>"x3"</span></span>
<span><span class="co">#&gt; <span style="color: #0000BB;">FROM</span> "df"</span></span></code></pre></div>
<p>Currently there is no way to order by multiple variables, except by
setting the default ordering with <code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange()</a></code>. This will be
added in a future release.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, Maximilian Girlich, Edgar Ruiz, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
