<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developing a dbplyr backend • dbplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Developing a dbplyr backend">
<meta name="robots" content="noindex">
<script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="dbplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dbplyr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.5.2.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dbplyr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/new-backend.html">Developing a dbplyr backend</a></li>
    <li><a class="dropdown-item" href="../articles/reprex.html">Reprexes for dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/translation-function.html">Function translation</a></li>
    <li><a class="dropdown-item" href="../articles/translation-verb.html">Verb translation</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2024/04/dbplyr-2-5-0/">Version 2.5.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/10/dbplyr-2-4-0/">Version 2.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2023/01/dbplyr-2-3-0/">Version 2.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2022/06/dbplyr-2-2-0/">Version 2.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2021/02/dplyr-backends/">Version 2.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/11/dbplyr-2-0-0/">Version 2.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/04/dbplyr-1-4-0/">Version 1.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/01/dbplyr-1-3-0/">Version 1.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/01/dbplyr-1-2/">Version 1.2.0</a></li>
    <li><a class="external-link dropdown-item" href="https://blog.rstudio.com/2017/06/27/dbplyr-1-1-0/">Version 1.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/dbplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Developing a dbplyr backend</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/main/vignettes/new-backend.Rmd" class="external-link"><code>vignettes/new-backend.Rmd</code></a></small>
      <div class="d-none name"><code>new-backend.Rmd</code></div>
    </div>

    
    
<p>This document describes how to add a new SQL backend to dbplyr. To
begin:</p>
<ul>
<li><p>Ensure that you have a DBI compliant database backend. If not,
you’ll need to first create it by following the instructions in
<code><a href="https://dbi.r-dbi.org/articles/backend.html" class="external-link">vignette("backend", package = "DBI")</a></code>.</p></li>
<li><p>You’ll need a working knowledge of S3. Make sure that you’re <a href="https://adv-r.hadley.nz/s3.html" class="external-link">familiar with the basics</a>
before you start.</p></li>
</ul>
<p>This document is still a work in progress, but it will hopefully get
you started. I’d also strongly recommend reading the bundled source code
for <a href="https://github.com/tidyverse/dbplyr/blob/master/R/backend-sqlite.R" class="external-link">SQLite</a>,
<a href="https://github.com/tidyverse/dbplyr/blob/master/R/backend-mysql.R" class="external-link">MySQL</a>,
and <a href="https://github.com/tidyverse/dbplyr/blob/master/R/backend-postgres.R" class="external-link">PostgreSQL</a>.</p>
<div class="section level2">
<h2 id="first-steps">First steps<a class="anchor" aria-label="anchor" href="#first-steps"></a>
</h2>
<p>For interactive exploitation, attach dplyr and DBI. If you’re
creating a package, you’ll need to import dplyr and DBI.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/">dbplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span></code></pre></div>
<p>Check that you can create a tbl from a connection, like:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, path <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"mtcars"</span>, <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"mtcars"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A query:  ?? x 11</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: sqlite 3.51.2 []</span></span></span>
<span><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>  18.7     8   360   175  3.15  3.44  17.0     0     0     3     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>  18.1     6   225   105  2.76  3.46  20.2     1     0     3     1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span></code></pre></div>
<p>If you can’t, this likely indicates some problem with the DBI
methods. Use <a href="https://github.com/r-dbi/DBItest" class="external-link">DBItest</a> to
narrow down the problem.</p>
</div>
<div class="section level2">
<h2 id="write-your-first-method">Write your first method<a class="anchor" aria-label="anchor" href="#write-your-first-method"></a>
</h2>
<p>The first method of your dbplyr backend should always be for the
<code><a href="../reference/db-misc.html">dbplyr_edition()</a></code> generic:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom dbplyr dbplyr_edition</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">dbplyr_edition.myConnectionClass</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="fl">2L</span></span></code></pre></div>
<p>This declares that your package uses version 2 of the API, which is
the version that this vignette documents.</p>
</div>
<div class="section level2">
<h2 id="define-a-dialect">Define a dialect<a class="anchor" aria-label="anchor" href="#define-a-dialect"></a>
</h2>
<p>Next, define a dialect for your backend using
<code><a href="../reference/sql_dialect.html">sql_dialect()</a></code> and <code><a href="../reference/sql_dialect.html">new_sql_dialect()</a></code>. A dialect
encapsulates the SQL syntax rules for your database:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">sql_dialect.myConnectionClass</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sql_dialect.html">new_sql_dialect</a></span><span class="op">(</span></span>
<span>    <span class="st">"mybackend"</span>,</span>
<span>    quote_identifier <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/sql_quote.html">sql_quote</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">'"'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code><a href="../reference/sql_dialect.html">new_sql_dialect()</a></code> function requires two
arguments:</p>
<ul>
<li>
<code>dialect</code>: A unique name for your backend (used to create
the class name).</li>
<li>
<code>quote_identifier</code>: A function that quotes identifiers.
This will typically b e either a call to <code><a href="../reference/sql_quote.html">sql_quote()</a></code> or to
<code><a href="https://dbi.r-dbi.org/reference/dbQuoteIdentifier.html" class="external-link">DBI::dbQuoteIdentifier()</a></code>
</li>
</ul>
<p><code><a href="../reference/sql_dialect.html">new_sql_dialect()</a></code> has a number of additional arguments
that describe the capabilities of the SQL dialect; see
<code><a href="../reference/sql_dialect.html">?new_sql_dialect</a></code> for details.</p>
<p>The dialect system allows you to write methods that dispatch on the
dialect class (e.g., <code>sql_translation.sql_dialect_mybackend</code>)
rather than the connection class. This makes it easier to share SQL
generation code between different connection types that use the same
database (e.g. direct, ODBC, JDBC, ADBC).</p>
<p>In general, generics that start with <code>sql_</code> should have a
sql_dialect method, and generics that start with <code>db_</code> should
use a DBI connection method. It should be relatively rare to need a
method for <code>db_</code> generic, but occassionally dbplyr’s SQL
generation system is not quite flexible enough. If you find this, it’s
worth filing an issue so I can look into it.</p>
</div>
<div class="section level2">
<h2 id="copying-computing-collecting-and-collapsing">Copying, computing, collecting and collapsing<a class="anchor" aria-label="anchor" href="#copying-computing-collecting-and-collapsing"></a>
</h2>
<p>Next, check that <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collapse()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code>, and <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> work:</p>
<ul>
<li><p>If <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code> fails, you probably need a method for
<code><a href="../reference/db-sql.html">sql_table_analyze()</a></code> or <code><a href="../reference/db-sql.html">sql_table_index()</a></code>. If
<code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code> fails during creation of the tbl, you may need a
method for <code><a href="../reference/db-sql.html">sql_query_fields()</a></code>.</p></li>
<li><p>If <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collapse()</a></code> fails, your database has a
non-standard way of constructing subqueries. Add a method for
<code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html" class="external-link">sql_subquery()</a></code>.</p></li>
<li><p>If <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> fails, your database has a non-standard
way of saving queries in temporary tables. Add a method for
<code><a href="https://dplyr.tidyverse.org/reference/backend_dbplyr.html" class="external-link">db_save_query()</a></code>.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="sql-translation-verbs">SQL translation: verbs<a class="anchor" aria-label="anchor" href="#sql-translation-verbs"></a>
</h2>
<p>Make sure you’ve read <code><a href="../articles/translation-verb.html">vignette("translation-verb")</a></code> so
you have the lay of the land. First check that SQL translation for the
key verbs work:</p>
<ul>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code> etc: powered by
<code><a href="../reference/db-sql.html">sql_query_select()</a></code>
</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join()</a></code>: powered by
<code><a href="../reference/db-sql.html">sql_query_join()</a></code>
</li>
<li>
<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">semi_join()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join()</a></code>: powered by
<code><a href="../reference/db-sql.html">sql_query_semi_join()</a></code>
</li>
<li>
<code><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">union()</a></code>, <code><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect()</a></code>,
<code><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff()</a></code>: powered by <code><a href="../reference/db-sql.html">sql_query_set_op()</a></code>
</li>
</ul>
<div class="section level3">
<h3 id="building-sql-strings">Building SQL strings<a class="anchor" aria-label="anchor" href="#building-sql-strings"></a>
</h3>
<p>If you need to generate your own SQL, we recommend using
<code><a href="../reference/sql_glue.html">sql_glue2()</a></code>. It uses glue syntax with type markers for safe
SQL generation:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend-ansi.html">simulate_dbi</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create an index</span></span>
<span><span class="va">index_name</span> <span class="op">&lt;-</span> <span class="st">"index"</span></span>
<span><span class="va">table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="st">"schema.table"</span><span class="op">)</span></span>
<span><span class="va">columns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"column1"</span>, <span class="st">"column2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sql_glue.html">sql_glue2</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"CREATE INDEX {.id index_name} ON {.tbl table} {.id columns*}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; CREATE INDEX "index" ON schema.table ("column1", "column2")</span></span>
<span></span>
<span><span class="co"># Insert values safely</span></span>
<span><span class="va">name</span> <span class="op">&lt;-</span> <span class="st">"O'Brien"</span></span>
<span><span class="fu"><a href="../reference/sql_glue.html">sql_glue2</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"INSERT INTO students (name) VALUES {name*}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; INSERT INTO students (name) VALUES ('O''Brien')</span></span>
<span></span>
<span><span class="co"># Build a query</span></span>
<span><span class="va">table</span> <span class="op">&lt;-</span> <span class="st">"my_table"</span></span>
<span><span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"value"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/sql_glue.html">sql_glue2</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT {.id cols} FROM {.tbl table}"</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;SQL&gt; SELECT "id", "name", "value" FROM "my_table"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="behind-the-scenes">Behind the scenes<a class="anchor" aria-label="anchor" href="#behind-the-scenes"></a>
</h3>
<p>The high-level translation from R code to SQL takes place in a few
steps, using two intermediate representations: a “lazy query” and a
“query”. A lazy query is closer to R and a query is closer to SQL. This
continuum of representation allows us to work with expressions when
trying to reason about the transformation pipeline, then later switch to
strings of SQL when we get closer to generating a query.</p>
<p>All dbplyr pipelines are built on top of the <code>tbl_lazy</code>
data structure, which is the only data structure that the user will ever
see. It has two fields:</p>
<ul>
<li>A database <code>con</code>nection which is used to specialise SQL
translation.</li>
<li>A <code>lazy_query</code> which represents the lazy computation
described by the pipeline. It always starts off as a
<code>lazy_base_query</code> which represents a remote table or SQL
query.</li>
</ul>
<p>Each verb takes a <code>tbl_lazy</code> as input and returns a
modified <code>tbl_lazy</code>, modifying the <code>lazy_query</code>
with the new requirements. At the simplest level, this involves wrapping
the existing lazy query within a new lazy query, such as
<code>lazy_query_select()</code> or
<code>lazy_query_multi_join()</code>. These represent what later will
become a subquery so that (e.g.) <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange()</a></code>,
and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise()</a></code> all use <code><a href="../reference/sql_build.html">lazy_select_query()</a></code>,
whereas <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join()</a></code> use
<code>lazy_query_multi_join()</code>.</p>
<p>These lazy queries are typically created by a helper function like
<code>add_select()</code>, <code>add_mutate()</code>, and
<code>add_filter()</code>. These helpers have two roles:</p>
<ol style="list-style-type: decimal">
<li><p>They abstract away repeated code for substantially similar dplyr
verbs. For example, <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename_with()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate()</a></code> all use
<code>add_select()</code>.</p></li>
<li><p>They are responsible for figuring out if we can re-use the
existing query or we need to wrap in a subquery. Typically this work is
done by a function called <code>can_inline_select()</code> which will
use what we know about SQL and the verb to determine whether or not we
have to introduce a subquery.</p></li>
</ol>
<p>The lazy query gives us a representation of the data manipulation
pipeline with enough detail that we can reason about when we need a
subquery. Then when the user calls <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code>, we need to
generate an SQL query. This happens in two steps: building and
rendering.</p>
<p>First, <code><a href="../reference/sql_build.html">sql_build()</a></code> recurses over the lazy query,
building up query objects like <code><a href="../reference/sql_build.html">select_query()</a></code> and
<code>multi_join_query()</code> that represent the different subtypes of
<code>SELECT</code> queries. Compared to the previous “lazy” query
representation, these are much closer to SQL than R. They can be much
simpler because we no longer need to reason about subqueries, but we
still need some structure to facilitate backend-specific
translations.</p>
<p>Next, <code><a href="../reference/sql_build.html">sql_render()</a></code> is called on the result of
<code><a href="../reference/sql_build.html">sql_build()</a></code> and dispatches to generics like
<code><a href="../reference/db-sql.html">sql_query_select()</a></code>, <code><a href="../reference/db-sql.html">sql_query_join()</a></code>,
<code><a href="../reference/db-sql.html">sql_query_semi_join()</a></code>, and <code><a href="../reference/db-sql.html">sql_query_set_op()</a></code>.
These generics have methods for each backend that are responsible for
creating the needed SQL.</p>
</div>
</div>
<div class="section level2">
<h2 id="sql-translation-vectors">SQL translation: vectors<a class="anchor" aria-label="anchor" href="#sql-translation-vectors"></a>
</h2>
<p>Finally, you may have to provide custom R -&gt; SQL translation for
functions that work with vectors within verbs. You can do this by
providing a method for <code><a href="../reference/db-sql.html">sql_translation()</a></code>, which returns an
object created by <code><a href="../reference/sql_variant.html">sql_variant()</a></code>.</p>
<p>You can define translation methods either on your connection class or
on your dialect class. Using the dialect class is recommended as it
allows sharing translations between different connection types:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Method on dialect class (recommended)</span></span>
<span><span class="va">sql_translation.sql_dialect_mybackend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sql_variant.html">sql_variant</a></span><span class="op">(</span></span>
<span>    scalar <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_scalar</span>, <span class="va">...</span><span class="op">)</span>, <span class="co"># Functions in SELECT (non-aggregated)</span></span>
<span>    aggregate <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_aggregate</span>, <span class="va">...</span><span class="op">)</span>, <span class="co"># Aggregation functions (mean, sum, etc.)</span></span>
<span>    window <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_win</span>, <span class="va">...</span><span class="op">)</span> <span class="co"># Window functions (lead, lag, rank, etc.)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Each translator will inherits from the base (ANSI SQL) translator and
overrides only what’s different for your backend:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span></span>
<span>  <span class="va">base_scalar</span>, <span class="co"># Inherit most translations</span></span>
<span>  <span class="co"># Override specific functions for your backend</span></span>
<span>  `+` <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_infix</a></span><span class="op">(</span><span class="st">"+"</span><span class="op">)</span>,</span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_aggregate</a></span><span class="op">(</span><span class="st">"AVERAGE"</span>, <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="scalar-function-helpers">Scalar function helpers<a class="anchor" aria-label="anchor" href="#scalar-function-helpers"></a>
</h3>
<p>dbplyr provides several helper functions to make it easier to
translate R functions to SQL:</p>
<ul>
<li>
<strong><code>sql_prefix(f, n = NULL)</code></strong>: For standard
SQL functions. The <code>n</code> argument optionally specifies the
number of arguments.</li>
<li>
<strong><code>sql_infix(f)</code></strong>: For infix operators like
<code>+</code>, <code>*</code>, or <code>==</code>.</li>
<li>
<strong><code>sql_cast(type)</code></strong>: For type casting
functions.</li>
<li>
<strong><code>sql_not_supported(f)</code></strong>: For functions
with no SQL translation.</li>
</ul>
<p>Here’s an example showing all of these helpers in use:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_translation.sql_dialect_mybackend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sql_variant.html">sql_variant</a></span><span class="op">(</span></span>
<span>    scalar <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span></span>
<span>      <span class="va">base_scalar</span>,</span>
<span>      <span class="co"># Standard SQL functions</span></span>
<span>      cos <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_prefix</a></span><span class="op">(</span><span class="st">"COS"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>      round <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_prefix</a></span><span class="op">(</span><span class="st">"ROUND"</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="co"># Infix operators</span></span>
<span>      `+` <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_infix</a></span><span class="op">(</span><span class="st">"+"</span><span class="op">)</span>,</span>
<span>      `*` <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_infix</a></span><span class="op">(</span><span class="st">"*"</span><span class="op">)</span>,</span>
<span>      `==` <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_infix</a></span><span class="op">(</span><span class="st">"="</span><span class="op">)</span>,</span>
<span>      <span class="co"># Type casting</span></span>
<span>      as.numeric <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_cast</a></span><span class="op">(</span><span class="st">"NUMERIC"</span><span class="op">)</span>,</span>
<span>      as.character <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_scalar.html">sql_cast</a></span><span class="op">(</span><span class="st">"VARCHAR"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    aggregate <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_agg</span><span class="op">)</span>,</span>
<span>    window <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_win</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregation-function-helpers">Aggregation function helpers<a class="anchor" aria-label="anchor" href="#aggregation-function-helpers"></a>
</h3>
<ul>
<li>
<strong><code>sql_aggregate(f, f_r = f)</code></strong>: For
single-argument SQL aggregate functions. The <code>f_r</code> argument
gives the name of the R function.</li>
<li>
<strong><code>sql_aggregate_2(f)</code></strong>: For two-argument
SQL aggregate functions.</li>
<li>
<strong><code>sql_aggregate_n(f, f_r = f)</code></strong>: For
variadic SQL aggregate functions.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql_translation.sql_dialect_mybackend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/sql_variant.html">sql_variant</a></span><span class="op">(</span></span>
<span>    scalar <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_scalar</span><span class="op">)</span>,</span>
<span>    aggregate <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span></span>
<span>      .parent <span class="op">=</span> <span class="va">base_agg</span>,</span>
<span>      <span class="co"># Single-argument aggregates</span></span>
<span>      mean <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_aggregate</a></span><span class="op">(</span><span class="st">"AVG"</span>, <span class="st">"mean"</span><span class="op">)</span>,</span>
<span>      var <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_aggregate</a></span><span class="op">(</span><span class="st">"VAR_SAMP"</span>, <span class="st">"var"</span><span class="op">)</span>,</span>
<span>      <span class="co"># Two-argument aggregates</span></span>
<span>      cov <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_aggregate_2</a></span><span class="op">(</span><span class="st">"COVAR_SAMP"</span><span class="op">)</span>,</span>
<span>      <span class="co"># Variadic aggregates</span></span>
<span>      pmin <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_aggregate_n</a></span><span class="op">(</span><span class="st">"LEAST"</span>, <span class="st">"pmin"</span><span class="op">)</span>,</span>
<span>      pmax <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_aggregate_n</a></span><span class="op">(</span><span class="st">"GREATEST"</span>, <span class="st">"pmax"</span><span class="op">)</span>,</span>
<span>      <span class="co"># Unsupported functions</span></span>
<span>      median <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_agg.html">sql_not_supported</a></span><span class="op">(</span><span class="st">"median"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    window <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span><span class="va">base_win</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="window-function-helpers">Window function helpers<a class="anchor" aria-label="anchor" href="#window-function-helpers"></a>
</h3>
<p>Window functions have their own set of helpers:</p>
<ul>
<li>
<strong><code>win_rank(f)</code></strong>: For ranking
functions.</li>
<li>
<strong><code>win_aggregate(f)</code></strong>: For aggregate
functions used as window functions.</li>
<li>
<strong><code>win_cumulative(f)</code></strong>: For cumulative
functions.</li>
<li>
<strong><code>win_absent(f)</code></strong>: For backends that don’t
support certain window functions.</li>
</ul>
<p>Here’s an example showing all of these helpers in use:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">window</span> <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span></span>
<span>  <span class="va">base_win</span>,</span>
<span>  <span class="co"># Ranking functions</span></span>
<span>  row_number <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_rank</a></span><span class="op">(</span><span class="st">"ROW_NUMBER"</span><span class="op">)</span>,</span>
<span>  rank <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_rank</a></span><span class="op">(</span><span class="st">"RANK"</span><span class="op">)</span>,</span>
<span>  dense_rank <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_rank</a></span><span class="op">(</span><span class="st">"DENSE_RANK"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Aggregate functions as window functions</span></span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_aggregate</a></span><span class="op">(</span><span class="st">"AVG"</span><span class="op">)</span>,</span>
<span>  sum <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_aggregate</a></span><span class="op">(</span><span class="st">"SUM"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Cumulative functions</span></span>
<span>  cumsum <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_cumulative</a></span><span class="op">(</span><span class="st">"SUM"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Absent functions</span></span>
<span>  cume_dist <span class="op">=</span> <span class="fu"><a href="../reference/sql_translation_window.html">win_absent</a></span><span class="op">(</span><span class="st">"cume_dist"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-translation-functions">Custom translation functions<a class="anchor" aria-label="anchor" href="#custom-translation-functions"></a>
</h3>
<p>For more complex translations, you can write custom functions that
return SQL expressions using <code><a href="../reference/sql_glue.html">sql_glue()</a></code>. This uses glue
syntax for string interpolation with automatic escaping.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scalar</span> <span class="op">=</span> <span class="fu"><a href="../reference/sql_variant.html">sql_translator</a></span><span class="op">(</span></span>
<span>  <span class="va">base_scalar</span>,</span>
<span></span>
<span>  <span class="co"># Custom log function with change of base</span></span>
<span>  log <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">base</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">base</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/sql_glue.html">sql_glue</a></span><span class="op">(</span><span class="st">"LN({x})"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="../reference/sql_glue.html">sql_glue</a></span><span class="op">(</span><span class="st">"LOG({x}) / LOG({base})"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  <span class="co"># Custom paste function using CONCAT</span></span>
<span>  paste <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">sep</span> <span class="op">=</span> <span class="st">" "</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/sql_glue.html">sql_glue</a></span><span class="op">(</span><span class="st">"CONCAT_WS({sep}, {...})"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, Maximilian Girlich, Edgar Ruiz, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer>
</body>
</html>
