<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SQL translation • dbplyr</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<meta property="og:title" content="SQL translation">
<meta property="og:description" content="">
<meta property="og:image" content="https://dbplyr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- google analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
 window.dataLayer = window.dataLayer || [];
 function gtag(){dataLayer.push(arguments);}
 gtag('js', new Date());

 gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dbplyr</a>
        <div class="info">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.1.9001</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/dbplyr.html">Intro</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sql-translation.html">SQL translation</a>
    </li>
    <li>
      <a href="../articles/new-backend.html">Creating new backends</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
        <li>
  <a href="https://github.com/tidyverse/dbplyr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>SQL translation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dbplyr/blob/master/vignettes/sql-translation.Rmd"><code>vignettes/sql-translation.Rmd</code></a></small>
      <div class="hidden name"><code>sql-translation.Rmd</code></div>

    </div>

    
    
<p>There are two components to dplyr’s SQL translation system:</p>
<ul>
<li><p>translation of vector expressions like <code>x * y + 10</code></p></li>
<li><p>translation of whole verbs like <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> or <code><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code></p></li>
</ul>
<p>To explore them, you’ll need to load both dbplyr and dplyr:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dbplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a></code></pre></div>
<div id="vectors" class="section level2">
<h2 class="hasAnchor">
<a href="#vectors" class="anchor"></a>Vectors</h2>
<p>Most filtering, mutating or summarising operations only perform simple mathematical operations. These operations are very similar between R and SQL, so they’re easy to translate. To see what’s happening yourself, you can use <code><a href="../reference/translate_sql.html">translate_sql()</a></code>. The basic techniques that underlie the implementation of <code><a href="../reference/translate_sql.html">translate_sql()</a></code> are described in <a href="http://adv-r.had.co.nz/dsl.html">“Advanced R”</a>. <code><a href="../reference/translate_sql.html">translate_sql()</a></code> is built on top of R’s parsing engine and has been carefully designed to generate correct SQL. It also protects you against SQL injection attacks by correctly escaping the strings and variable names needed by the database that you’re connecting to.</p>
<p>The following examples work through some of the basic differences between R and SQL.</p>
<ul>
<li>
<p><code>"</code> and <code>'</code> mean different things</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># In SQLite variable names are escaped by double quotes:</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(x)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; &lt;SQL&gt; "x"</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co"># And strings are escaped by single quotes</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt; &lt;SQL&gt; 'x'</span></a></code></pre></div>
</li>
<li>
<p>Many functions have slightly different names</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(x <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;&amp;</span><span class="st"> </span>(y <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span> <span class="op">||</span><span class="st"> </span>z <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; "x" = 1.0 AND ("y" &lt; 2.0 OR "z" &gt; 3.0)</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(x <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">&lt;</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt; POWER("x", 2.0) &lt; 10.0</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span> <span class="op">==</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; &lt;SQL&gt; "x" % 2.0 = 10.0</span></a></code></pre></div>
</li>
<li>
<p>And some functions have different argument orders:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substr">substr</a></span>(x, <span class="dv">5</span>, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; substr("x", 5, 6)</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(x, <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt; LOG(10.0, "x")</span></a></code></pre></div>
</li>
<li>
<p>R and SQL have different defaults for integers and reals. In R, 1 is a real, and 1L is an integer. In SQL, 1 is an integer, and 1.0 is a real</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; 1.0</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(1L)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt; 1</span></a></code></pre></div>
</li>
<li>
<p>If statements are translated into a case statement:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="cf">if</span> (x <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span>) <span class="st">"big"</span> <span class="cf">else</span> <span class="st">"small"</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; CASE WHEN ("x" &gt; 5.0) THEN ('big') WHEN NOT("x" &gt; 5.0) THEN ('small') </span><span class="re">END</span></a></code></pre></div>
</li>
</ul>
<div id="known-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#known-functions" class="anchor"></a>Known functions</h3>
<p>dplyr knows how to convert the following R functions to SQL:</p>
<ul>
<li>basic math operators: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%%</code>, <code>^</code>
</li>
<li>math functions: <code>abs</code>, <code>acos</code>, <code>acosh</code>, <code>asin</code>, <code>asinh</code>, <code>atan</code>, <code>atan2</code>, <code>atanh</code>, <code>ceiling</code>, <code>cos</code>, <code>cosh</code>, <code>cot</code>, <code>coth</code>, <code>exp</code>, <code>floor</code>, <code>log</code>, <code>log10</code>, <code>round</code>, <code>sign</code>, <code>sin</code>, <code>sinh</code>, <code>sqrt</code>, <code>tan</code>, <code>tanh</code>
</li>
<li>logical comparisons: <code>&lt;</code>, <code>&lt;=</code>, <code>!=</code>, <code>&gt;=</code>, <code>&gt;</code>, <code>==</code>, <code>%in%</code>
</li>
<li>boolean operations: <code>&amp;</code>, <code>&amp;&amp;</code>, <code>|</code>, <code>||</code>, <code>!</code>, <code>xor</code>
</li>
<li>basic aggregations: <code>mean</code>, <code>sum</code>, <code>min</code>, <code>max</code>, <code>sd</code>, <code>var</code>
</li>
<li>string functions: <code>tolower</code>, <code>toupper</code>, <code>trimws</code>, <code>nchar</code>, <code>substr</code>
</li>
<li>coerce types: <code>as.numeric</code>, <code>as.integer</code>, <code>as.character</code>
</li>
</ul>
<p>Perfect translation is not possible because databases don’t have all the functions that R does. The goal of dplyr is to provide a semantic rather than a literal translation: what you mean rather than what is done. In fact, even for functions that exist both in databases and R, you shouldn’t expect results to be identical; database programmers have different priorities than R core programmers. For example, in R in order to get a higher level of numerical accuracy, <code><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean()</a></code> loops through the data twice. R’s <code><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean()</a></code> also provides a <code>trim</code> option for computing trimmed means; this is something that databases do not provide. Databases automatically drop NULLs (their equivalent of missing values) whereas in R you have to ask nicely. This means the essence of simple calls like <code><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean(x)</a></code> will be translated accurately, but more complicated calls like <code><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean(x, trim = 0.5, na.rm = TRUE)</a></code> will raise an error:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(x, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; avg("x") OVER ()</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(x, <span class="dt">trim =</span> <span class="fl">0.1</span>))</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; Error in mean(x, trim = 0.1): unused argument (trim = 0.1)</span></a></code></pre></div>
<p><code><a href="../reference/translate_sql.html">translate_sql()</a></code> takes an optional <code>con</code> parameter. If not supplied, this causes dplyr to generate (approximately) SQL-92 compliant SQL. If supplied, dplyr uses <code><a href="http://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_translate_env()</a></code> to look up a custom environment which makes it possible for different databases to generate slightly different SQL: see <code><a href="../articles/new-backend.html">vignette("new-backend")</a></code> for more details.</p>
</div>
<div id="unknown-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#unknown-functions" class="anchor"></a>Unknown functions</h3>
<p>Any function that dplyr doesn’t know how to convert is left as is. This means that database functions that are not covered by dplyr can be used directly via <code><a href="../reference/translate_sql.html">translate_sql()</a></code>. Here a couple of examples that will work with <a href="http://www.sqlite.org/lang_corefunc.html">SQLite</a>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw">glob</span>(x, y))</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; GLOB("x", "y")</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(x <span class="op">%like%</span><span class="st"> "ab%"</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt; "x" LIKE 'ab%'</span></a></code></pre></div>
</div>
<div id="window-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#window-functions" class="anchor"></a>Window functions</h3>
<p>Things get a little trickier with window functions, because SQL’s window functions are considerably more expressive than the specific variants provided by base R or dplyr. They have the form <code>[expression] OVER ([partition clause] [order clause] [frame_clause])</code>:</p>
<ul>
<li><p>The <strong>expression</strong> is a combination of variable names and window functions. Support for window functions varies from database to database, but most support the ranking functions, <code>lead</code>, <code>lag</code>, <code>nth</code>, <code>first</code>, <code>last</code>, <code>count</code>, <code>min</code>, <code>max</code>, <code>sum</code>, <code>avg</code> and <code>stddev</code>.</p></li>
<li><p>The <strong>partition clause</strong> specifies how the window function is broken down over groups. It plays an analogous role to <code>GROUP BY</code> for aggregate functions, and <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> in dplyr. It is possible for different window functions to be partitioned into different groups, but not all databases support it, and neither does dplyr.</p></li>
<li><p>The <strong>order clause</strong> controls the ordering (when it makes a difference). This is important for the ranking functions since it specifies which variables to rank by, but it’s also needed for cumulative functions and lead. Whenever you’re thinking about before and after in SQL, you must always tell it which variable defines the order. If the order clause is missing when needed, some databases fail with an error message while others return non-deterministic results.</p></li>
<li>
<p>The <strong>frame clause</strong> defines which rows, or <strong>frame</strong>, that are passed to the window function, describing which rows (relative to the current row) should be included. The frame clause provides two offsets which determine the start and end of frame. There are three special values: -Inf means to include all preceeding rows (in SQL, “unbounded preceding”), 0 means the current row (“current row”), and Inf means all following rows (“unbounded following)”. The complete set of options is comprehensive, but fairly confusing, and is summarised visually below.</p>
<p><img src="windows.png" width="100%"></p>
<p>Of the many possible specifications, there are only three that commonly used. They select between aggregation variants:</p>
<ul>
<li><p>Recycled: <code>BETWEEN UNBOUND PRECEEDING AND UNBOUND FOLLOWING</code></p></li>
<li><p>Cumulative: <code>BETWEEN UNBOUND PRECEEDING AND CURRENT ROW</code></p></li>
<li><p>Rolling: <code>BETWEEN 2 PRECEEDING AND 2 FOLLOWING</code></p></li>
</ul>
<p>dplyr generates the frame clause based on whether your using a recycled aggregate or a cumulative aggregate.</p>
</li>
</ul>
<p>To see how individual window functions are translated to SQL, we can again use <code><a href="../reference/translate_sql.html">translate_sql()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(G))</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; Warning: Missing values are always removed in SQL.</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; Use `avg(x, na.rm = TRUE)` to silence this warning</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt; avg("G") OVER ()</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rank">rank</a></span>(G))</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; &lt;SQL&gt; rank() OVER (ORDER BY "G")</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span>(G, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt; &lt;SQL&gt; NTILE(2) OVER (ORDER BY "G")</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span>(G))</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; &lt;SQL&gt; LAG("G", 1, NULL) OVER ()</span></a></code></pre></div>
<p>If the tbl has been grouped or arranged previously in the pipeline, then dplyr will use that information to set the “partition by” and “order by” clauses. For interactive exploration, you can achieve the same effect by setting the <code>vars_group</code> and <code>vars_order</code> arguments to <code><a href="../reference/translate_sql.html">translate_sql()</a></code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/cumall.html">cummean</a></span>(G), <span class="dt">vars_order =</span> <span class="st">"year"</span>)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt; &lt;SQL&gt; avg("G") OVER (ORDER BY "year" ROWS UNBOUNDED PRECEDING)</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="kw"><a href="../reference/translate_sql.html">translate_sql</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rank">rank</a></span>(), <span class="dt">vars_group =</span> <span class="st">"ID"</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt; rank() OVER (PARTITION BY "ID")</span></a></code></pre></div>
<p>There are some challenges when translating window functions between R and SQL, because dplyr tries to keep the window functions as similar as possible to both the existing R analogues and to the SQL functions. This means that there are three ways to control the order clause depending on which window function you’re using:</p>
<ul>
<li><p>For ranking functions, the ordering variable is the first argument: <code><a href="https://www.rdocumentation.org/packages/base/topics/rank">rank(x)</a></code>, <code><a href="http://dplyr.tidyverse.org/reference/ranking.html">ntile(y, 2)</a></code>. If omitted or <code>NULL</code>, will use the default ordering associated with the tbl (as set by <code><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>).</p></li>
<li><p>Accumulating aggregates only take a single argument (the vector to aggregate). To control ordering, use <code><a href="http://dplyr.tidyverse.org/reference/order_by.html">order_by()</a></code>.</p></li>
<li><p>Aggregates implemented in dplyr (<code>lead</code>, <code>lag</code>, <code>nth_value</code>, <code>first_value</code>, <code>last_value</code>) have an <code>order_by</code> argument. Supply it to override the default ordering.</p></li>
</ul>
<p>The three options are illustrated in the snippet below:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(players,</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="kw"><a href="http://dplyr.tidyverse.org/reference/ranking.html">min_rank</a></span>(yearID),</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="kw"><a href="http://dplyr.tidyverse.org/reference/order_by.html">order_by</a></span>(yearID, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cumsum">cumsum</a></span>(G)),</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="kw"><a href="http://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span>(G, <span class="dt">order_by =</span> yearID)</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">)</a></code></pre></div>
<p>Currently there is no way to order by multiple variables, except by setting the default ordering with <code><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>. This will be added in a future release.</p>
</div>
</div>
<div id="whole-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#whole-tables" class="anchor"></a>Whole tables</h2>
<p>All dplyr verbs generate a <code>SELECT</code> statement. To demonstrate we’ll make a temporary database with a couple of tables</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/DBI/topics/dbConnect">dbConnect</a></span>(RSQLite<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/RSQLite/topics/SQLite">SQLite</a></span>(), <span class="st">":memory:"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">flights &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(con, nycflights13<span class="op">::</span>flights)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">airports &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(con, nycflights13<span class="op">::</span>airports)</a></code></pre></div>
<div id="single-table-verbs" class="section level3">
<h3 class="hasAnchor">
<a href="#single-table-verbs" class="anchor"></a>Single table verbs</h3>
<ul>
<li>
<p><code><a href="http://dplyr.tidyverse.org/reference/select.html">select()</a></code> and <code><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> modify the <code>SELECT</code> clause:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">contains</a></span>(<span class="st">"delay"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; SELECT `dep_delay`, `arr_delay`</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; FROM `nycflights13::flights`</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(distance, air_time) <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">speed =</span> distance <span class="op">/</span><span class="st"> </span>(air_time <span class="op">/</span><span class="st"> </span><span class="dv">60</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; SELECT `distance`, `air_time`, `distance` / (`air_time` / 60.0) AS `speed`</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; FROM (SELECT `distance`, `air_time`</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; FROM `nycflights13::flights`)</span></a></code></pre></div>
<p>(As you can see here, the generated SQL isn’t always as minimal as you might generate by hand.)</p>
</li>
<li>
<p><code><a href="http://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> generates a <code>WHERE</code> clause:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(month <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, day <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="co">#&gt; SELECT *</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; FROM `nycflights13::flights`</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt; WHERE ((`month` = 1.0) AND (`day` = 1.0))</span></a></code></pre></div>
</li>
<li>
<p><code><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> generates an <code>ORDER BY</code> clause:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">flights <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(carrier, <span class="kw"><a href="http://dplyr.tidyverse.org/reference/desc.html">desc</a></span>(arr_delay)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="co">#&gt; &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; SELECT *</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">#&gt; FROM `nycflights13::flights`</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">#&gt; ORDER BY `carrier`, `arr_delay` DESC</span></a></code></pre></div>
</li>
<li>
<p><code><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> and <code><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> work together to generate a <code>GROUP BY</code> clause:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">flights <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(month, day) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(<span class="dt">delay =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(dep_delay)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/explain.html">show_query</a></span>()</a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co">#&gt; Warning: Missing values are always removed in SQL.</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt; Use `AVG(x, na.rm = TRUE)` to silence this warning</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt; &lt;SQL&gt;</span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co">#&gt; SELECT `month`, `day`, AVG(`dep_delay`) AS `delay`</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co">#&gt; FROM `nycflights13::flights`</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10"><span class="co">#&gt; GROUP BY `month`, `day`</span></a></code></pre></div>
</li>
</ul>
</div>
<div id="dual-table-verbs" class="section level3">
<h3 class="hasAnchor">
<a href="#dual-table-verbs" class="anchor"></a>Dual table verbs</h3>
<table class="table">
<colgroup>
<col width="23%">
<col width="76%">
</colgroup>
<thead><tr class="header">
<th>R</th>
<th>SQL</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="http://dplyr.tidyverse.org/reference/join.html">inner_join()</a></code></td>
<td><code>SELECT * FROM x JOIN y ON x.a = y.a</code></td>
</tr>
<tr class="even">
<td><code><a href="http://dplyr.tidyverse.org/reference/join.html">left_join()</a></code></td>
<td><code>SELECT * FROM x LEFT JOIN y ON x.a = y.a</code></td>
</tr>
<tr class="odd">
<td><code><a href="http://dplyr.tidyverse.org/reference/join.html">right_join()</a></code></td>
<td><code>SELECT * FROM x RIGHT JOIN y ON x.a = y.a</code></td>
</tr>
<tr class="even">
<td><code><a href="http://dplyr.tidyverse.org/reference/join.html">full_join()</a></code></td>
<td><code>SELECT * FROM x FULL JOIN y ON x.a = y.a</code></td>
</tr>
<tr class="odd">
<td><code><a href="http://dplyr.tidyverse.org/reference/join.html">semi_join()</a></code></td>
<td><code>SELECT * FROM x WHERE EXISTS (SELECT 1 FROM y WHERE x.a = y.a)</code></td>
</tr>
<tr class="even">
<td><code><a href="http://dplyr.tidyverse.org/reference/join.html">anti_join()</a></code></td>
<td><code>SELECT * FROM x WHERE NOT EXISTS (SELECT 1 FROM y WHERE x.a = y.a)</code></td>
</tr>
<tr class="odd">
<td><code><a href="http://dplyr.tidyverse.org/reference/setops.html">intersect(x, y)</a></code></td>
<td><code>SELECT * FROM x INTERSECT SELECT * FROM y</code></td>
</tr>
<tr class="even">
<td><code><a href="http://dplyr.tidyverse.org/reference/setops.html">union(x, y)</a></code></td>
<td><code>SELECT * FROM x UNION SELECT * FROM y</code></td>
</tr>
<tr class="odd">
<td><code><a href="http://dplyr.tidyverse.org/reference/setops.html">setdiff(x, y)</a></code></td>
<td><code>SELECT * FROM x EXCEPT SELECT * FROM y</code></td>
</tr>
</tbody>
</table>
<p><code>x</code> and <code>y</code> don’t have to be tables in the same database. If you specify <code>copy = TRUE</code>, dplyr will copy the <code>y</code> table into the same location as the <code>x</code> variable. This is useful if you’ve downloaded a summarised dataset and determined a subset of interest that you now want the full data for. You can use <code><a href="http://dplyr.tidyverse.org/reference/join.html">semi_join(x, y, copy = TRUE)</a></code> to upload the indices of interest to a temporary table in the same database as <code>x</code>, and then perform a efficient semi join in the database.</p>
<p>If you’re working with large data, it maybe also be helpful to set <code>auto_index = TRUE</code>. That will automatically add an index on the join variables to the temporary table.</p>
</div>
<div id="behind-the-scenes" class="section level3">
<h3 class="hasAnchor">
<a href="#behind-the-scenes" class="anchor"></a>Behind the scenes</h3>
<p>The verb level SQL translation is implemented on top of <code>tbl_lazy</code>, which basically tracks the operations you perform in a pipeline (see <code>lazy-ops.R</code>). Turning that into a SQL query takes place in three steps:</p>
<ul>
<li><p><code><a href="../reference/sql_build.html">sql_build()</a></code> recurses over the lazy op data structure building up query objects (<code><a href="../reference/sql_build.html">select_query()</a></code>, <code><a href="../reference/sql_build.html">join_query()</a></code>, <code><a href="../reference/sql_build.html">set_op_query()</a></code> etc) that represent the different subtypes of <code>SELECT</code> queries that we might generate.</p></li>
<li><p><code><a href="../reference/sql_build.html">sql_optimise()</a></code> takes a pass over these SQL objects, looking for potential optimisations. Currently this only involves removing subqueries where possible.</p></li>
<li><p><code><a href="../reference/sql_build.html">sql_render()</a></code> calls an SQL generation function (<code><a href="http://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_select()</a></code>, <code><a href="http://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_join()</a></code>, <code><a href="http://dplyr.tidyverse.org/reference/backend_dbplyr.html">sql_subquery()</a></code>, <code>sql_semijoin()</code> etc) to produce the actual SQL. Each of these functions is a generic, taking the connection as an argument, so that the details can be customised for different databases.</p></li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#vectors">Vectors</a></li>
      <li><a href="#whole-tables">Whole tables</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="tidyverse">
  <p>dbplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Edgar Ruiz, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>
      </footer>
</div>

  

  </body>
</html>
